<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-020D2NVH9F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-020D2NVH9F');
</script>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">
<meta property="og:title" content="Conference ‚Äî AIB College Basketball Ratings">
<meta property="og:description" content="College basketball rankings, bracketology, and analytics powered by AI Bracketology">
<meta property="og:image" content="https://ai-bracketology.github.io/cbb-rankings/docs/new_header.png">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conference ‚Äî CBB Ratings 2025-26</title>
<script>
  (function(){
    var t = localStorage.getItem("cbb_theme");
    if (t === "light") document.documentElement.setAttribute("data-theme","light");
  })();
  window.addEventListener("pageshow", function(e) {
    if (e.persisted) window.location.reload();
  });
</script>
<style>
  :root {
    --bg:        #0d1117;
    --surface:   #161b22;
    --border:    #30363d;
    --text:      #c9d1d9;
    --text-dim:  #8b949e;
    --accent:    #58a6ff;
    --green:     #3fb950;
    --red:       #f85149;
    --gold:      #d29922;
  }
  html[data-theme="light"] {
    --bg:        #ffffff;
    --surface:   #f6f8fa;
    --border:    #d0d7de;
    --text:      #1f2328;
    --text-dim:  #656d76;
    --accent:    #0969da;
    --green:     #1a7f37;
    --red:       #cf222e;
    --gold:      #9a6700;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
  }

  /* header */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  header a.back {
    color: var(--accent);
    text-decoration: none;
    font-size: .85rem;
  }
  header a.back:hover { text-decoration: underline; }
  header h1 { font-size: 1.4rem; font-weight: 600; }
  header .team-count { color: var(--text-dim); font-size: .9rem; margin-left: auto; }

  /* theme toggle */
  .theme-toggle {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 1.1rem;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: border-color .15s;
    line-height: 1;
  }
  .theme-toggle:hover { border-color: var(--accent); }

  /* conference dropdown */
  .conf-select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 6px 10px;
    font-size: .85rem;
    cursor: pointer;
    outline: none;
    margin-left: 12px;
  }
  .conf-select:hover, .conf-select:focus { border-color: var(--accent); }
  .conf-select option { background: var(--surface); color: var(--text); }

  /* summary strip */
  .summary {
    max-width: 1400px;
    margin: 20px auto 0;
    padding: 0 20px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .summary .chip {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 16px;
    font-size: .82rem;
  }
  .chip .val { font-weight: 700; color: var(--accent); }

  /* tabs */
  .tabs {
    max-width: 1400px;
    margin: 20px auto 0;
    padding: 0 20px;
    display: flex;
    gap: 4px;
  }
  .tab-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    color: var(--text-dim);
    padding: 9px 20px;
    font-size: .85rem;
    font-weight: 600;
    cursor: pointer;
    transition: color .15s, border-color .15s;
  }
  .tab-btn:hover { color: var(--text); }
  .tab-btn.active {
    color: var(--accent);
    border-color: var(--accent);
    background: var(--bg);
  }

  /* table */
  .table-wrap {
    max-width: 1400px;
    margin: 16px auto 40px;
    padding: 0 20px;
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: .82rem;
  }
  thead { position: sticky; top: 0; z-index: 2; }
  thead th {
    background: var(--surface);
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    padding: 10px 8px;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    text-align: center;
  }
  thead th:hover { color: var(--accent); }

  tbody tr { border-bottom: 1px solid var(--border); }
  tbody tr:hover { background: rgba(88,166,255,.06); }
  tbody td {
    padding: 8px 8px;
    white-space: nowrap;
    text-align: center;
  }
  tbody td:first-child { color: var(--text-dim); }
  tbody td:nth-child(2) { font-weight: 500; }

  .eff-good { color: var(--green); }
  .eff-bad  { color: var(--red); }
  .net-pos  { color: var(--green); font-weight: 600; }
  .net-neg  { color: var(--red); }
  .heatmap  { border-radius: 4px; }

  /* section divider for grouped columns */
  .section-start {
    border-left: 2px solid var(--accent) !important;
  }
  .section-end {
    border-right: 2px solid var(--accent) !important;
  }

  /* compact advanced-stats mode */
  table.adv-mode { table-layout: fixed; }
  table.adv-mode thead th {
    white-space: normal;
    word-break: break-word;
    font-size: .72rem;
    padding: 8px 4px;
    line-height: 1.25;
  }
  table.adv-mode tbody td {
    font-size: .78rem;
    padding: 6px 4px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* inline rank badge */
  .rk {
    display: inline-block;
    font-size: .65rem;
    color: var(--text-dim);
    margin-left: 4px;
    vertical-align: super;
    opacity: .75;
  }

  footer {
    text-align: center;
    padding: 24px;
    color: var(--text-dim);
    font-size: .75rem;
    border-top: 1px solid var(--border);
  }
  footer a { color: var(--accent); text-decoration: none; }

  /* ---------- conference power rankings ---------- */
  .conf-power-section {
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 20px;
  }
  .conf-power-section h2 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text);
  }
  .conf-power-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .82rem;
  }
  .conf-power-table thead th {
    background: var(--surface);
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    padding: 10px 8px;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    text-align: center;
  }
  .conf-power-table thead th:hover { color: var(--accent); }
  .conf-power-table tbody tr { border-bottom: 1px solid var(--border); }
  .conf-power-table tbody tr:hover { background: rgba(88,166,255,.06); }
  .conf-power-table tbody tr.current-conf {
    background: rgba(88,166,255,.10);
    border-left: 3px solid var(--accent);
  }
  .conf-power-table tbody td {
    padding: 8px 8px;
    white-space: nowrap;
    text-align: center;
  }
  .conf-power-table tbody td.conf-name-cell {
    text-align: left;
    font-weight: 500;
  }
  .conf-power-table tbody td.conf-name-cell a {
    color: var(--accent);
    text-decoration: none;
  }
  .conf-power-table tbody td.conf-name-cell a:hover { text-decoration: underline; }

  @media (max-width: 768px) {
    .conf-power-section { padding: 0 8px; }
    .conf-power-section h2 { font-size: 1rem; }
    .conf-power-table { font-size: .72rem; }
    .conf-power-table thead th { padding: 7px 4px; font-size: .68rem; }
    .conf-power-table tbody td { padding: 6px 4px; }
  }

  @media (max-width: 768px) {
    header {
      flex-direction: column;
      align-items: flex-start;
      padding: 14px 16px;
      gap: 6px;
    }
    header h1 { font-size: 1.15rem; }
    header .team-count { margin-left: 0; font-size: .8rem; }
    .conf-select { margin-left: 0; width: 100%; }

    .summary { padding: 0 12px; gap: 8px; }
    .chip { padding: 6px 10px !important; font-size: .75rem !important; }

    .tabs {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      flex-wrap: nowrap;
      padding: 0 12px;
      gap: 2px;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab-btn {
      padding: 7px 12px;
      font-size: .73rem;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .table-wrap {
      padding: 0 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    table { font-size: .72rem; }
    thead th { padding: 7px 4px; font-size: .68rem; }
    tbody td { padding: 6px 4px; }

    table.adv-mode {
      min-width: 1100px;
      font-size: 0.72rem;
    }
    table.adv-mode thead th, table.adv-mode tbody td {
      padding: 4px 2px;
      font-size: 0.72rem;
    }
    table.adv-mode thead th {
      white-space: normal;
      word-break: break-word;
    }
    table.adv-mode tbody td {
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }

  @media (max-width: 480px) {
    header h1 { font-size: 1rem; }
    .summary { flex-direction: column; }
    .chip { width: 100%; }
  }
</style>
</head>
<body>

<header>
  <a class="back" href="index.html">‚Üê Back to Rankings</a>
  <h1 id="confName">Loading‚Ä¶</h1>
  <select class="conf-select" id="confSelect">
    <option value="">Switch conference‚Ä¶</option>
  </select>
  <span class="team-count" id="teamCount"></span>
  <button class="theme-toggle" id="themeToggle" title="Toggle light/dark mode">üåô</button>
</header>

<div class="summary" id="summary"></div>

<div class="tabs">
  <button class="tab-btn active" id="tabRank">Team Rankings</button>
  <button class="tab-btn" id="tabQuad">Quadrant Records</button>
  <button class="tab-btn" id="tabAdvOff">Adv Offensive</button>
  <button class="tab-btn" id="tabAdvDef">Adv Defensive</button>
</div>

<div class="table-wrap">
  <table id="mainTable">
    <thead>
      <tr id="headerRow"></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="conf-power-section">
  <h2>Conference Power Rankings</h2>
  <div style="overflow-x:auto">
    <table class="conf-power-table" id="confPowerTable">
      <thead><tr id="confPowerHeader"></tr></thead>
      <tbody id="confPowerTbody"></tbody>
    </table>
  </div>
</div>

<footer>
  Built by <a href="https://github.com/ai-bracketology">AI Bracketology</a> ¬∑ Data sourced from ESPN
</footer>

<script>
/* ---- theme toggle ---- */
(function initThemeToggle() {
  const btn = document.getElementById("themeToggle");
  const isLight = document.documentElement.getAttribute("data-theme") === "light";
  btn.textContent = isLight ? "‚òÄÔ∏è" : "üåô";
  btn.addEventListener("click", () => {
    const nowLight = document.documentElement.getAttribute("data-theme") === "light";
    if (nowLight) {
      document.documentElement.removeAttribute("data-theme");
      localStorage.setItem("cbb_theme", "dark");
      btn.textContent = "üåô";
    } else {
      document.documentElement.setAttribute("data-theme", "light");
      localStorage.setItem("cbb_theme", "light");
      btn.textContent = "‚òÄÔ∏è";
    }
  });
})();

/* ---- column definitions (mirror index.html, without Conf column) ---- */

/* Tab 1: Team Rankings */
const RANK_COLS = [
  { key: "_rank",            label: "#",            fmt: v => v,              align: "center", rankKey: "rank_conf_standing" },
  { key: "team_displayName", label: "Team",         fmt: v => v,              align: "left" },
  { key: "proj_seed",        label: "Proj Seed",    fmt: v => v ?? "",        align: "center" },
  { key: "record",           label: "Record",       fmt: v => v ?? "‚Äì",       align: "center" },
  { key: "conf_record",      label: "Conf",         fmt: v => v ?? "‚Äì",       align: "center" },
  { key: "streak",           label: "Streak",       fmt: v => v ?? "‚Äì",       align: "center", sortKey: "streak_num", cls: v => v?.[0] === "W" ? "net-pos" : v?.[0] === "L" ? "net-neg" : "" },
  /* Efficiency */
  { key: "OffEff_srs",       label: "Adj OE",       fmt: v => v?.toFixed(2),  cls: v => v > 100 ? "eff-good" : v < 100 ? "eff-bad" : "", heat: "high", rank: "rank_off",  sectionStart: true, section: "Efficiency" },
  { key: "DefEff_srs",       label: "Adj DE",       fmt: v => v?.toFixed(2),  cls: v => v < 100 ? "eff-good" : v > 100 ? "eff-bad" : "", heat: "low",  rank: "rank_def" },
  { key: "net_srs",          label: "Total AdjE",   fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_net", sectionEnd: true },
  /* Resume */
  { key: "sos",              label: "SOS",           fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_sos",    sectionStart: true, section: "Resume" },
  { key: "nc_sos",           label: "NC SOS",        fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_nc_sos" },
  { key: "season_wab",       label: "WAB",           fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_wab" },
  { key: "slct",             label: "SLCT",          fmt: v => v?.toFixed(2),  heat: "high", rank: "rank_slct" },
  { key: "seed",             label: "SEED",          fmt: v => v?.toFixed(2),  heat: "high", rank: "rank_seed", sectionEnd: true },
];

/* Tab 2: Quadrant Records */
const QUAD_COLS = [
  { key: "_rank",            label: "#",            fmt: v => v,              align: "center", rankKey: "rank_wab" },
  { key: "team_displayName", label: "Team",         fmt: v => v,              align: "left" },
  { key: "proj_seed",        label: "Proj Seed",    fmt: v => v ?? "",        align: "center" },
  { key: "record",           label: "Record",       fmt: v => v ?? "‚Äì",       align: "center" },
  { key: "q1a_record",       label: "Q1A",          fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q1a_w" },
  { key: "q1_record",        label: "Q1",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q1_w" },
  { key: "q2_record",        label: "Q2",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q2_w" },
  { key: "q12_record",       label: "Q1+Q2",        fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q12_w" },
  { key: "q3_record",        label: "Q3",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q3_w" },
  { key: "q4_record",        label: "Q4",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q4_w" },
  { key: "season_wab",       label: "WAB",          fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_wab" },
];

/* Tab 3: Advanced Offensive Stats */
const ADV_OFF_COLS = [
  { key: "_rank",            label: "#",           fmt: v => v,              align: "center", rankKey: "rank_off", width: "36px" },
  { key: "team_displayName", label: "Team",        fmt: v => v,              align: "left",   width: "160px" },
  /* Shooting */
  { key: "adv_efg_pct",      label: "eFG%",        fmt: v => v?.toFixed(1),  heat: "high", sectionStart: true, section: "Shooting",       rank: "rank_adv_efg_pct" },
  { key: "adv_3pt_rate",     label: "3PT Rate",    fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_3pt_rate" },
  { key: "adv_3pt_pct",      label: "3PT%",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_3pt_pct" },
  { key: "adv_ftr",          label: "FTR",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_ftr" },
  { key: "adv_ft_pct",       label: "FT%",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_ft_pct", sectionEnd: true },
  /* Ball Control */
  { key: "adv_ast_rate",     label: "AST Rate",    fmt: v => v?.toFixed(1),  heat: "high", sectionStart: true, section: "Ball Control",   rank: "rank_adv_ast_rate" },
  { key: "adv_or_pct",       label: "OR%",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_or_pct" },
  { key: "adv_dr_pct",       label: "DR%",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_dr_pct" },
  { key: "adv_off_to_pct",   label: "Off TO%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_adv_off_to_pct" },
  { key: "adv_stl_pct",      label: "STL%",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_stl_pct" },
  { key: "adv_blk_pct",      label: "BLK%",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_blk_pct", sectionEnd: true },
  /* Scoring Breakdown */
  { key: "adv_to_pts_pct",   label: "TO Pts %",    fmt: v => v?.toFixed(1),  heat: "high", sectionStart: true, section: "Scoring Breakdown", rank: "rank_adv_to_pts_pct" },
  { key: "adv_fb_pts_pct",   label: "FSTBRK %",    fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_fb_pts_pct" },
  { key: "adv_pip_pct",      label: "Paint %",     fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_pip_pct", sectionEnd: true },
  /* Adj OE */
  { key: "OffEff_srs",       label: "Adj OE",      fmt: v => v?.toFixed(2),  cls: v => v > 100 ? "eff-good" : v < 100 ? "eff-bad" : "", heat: "high", rank: "rank_off" },
];

/* Tab 4: Advanced Defensive Stats */
const ADV_DEF_COLS = [
  { key: "_rank",            label: "#",           fmt: v => v,              align: "center", rankKey: "rank_def", width: "36px" },
  { key: "team_displayName", label: "Team",        fmt: v => v,              align: "left",   width: "160px" },
  /* Opp Shooting */
  { key: "def_efg_pct",      label: "Opp eFG%",    fmt: v => v?.toFixed(1),  heat: "low",  sectionStart: true, section: "Opp Shooting",       rank: "rank_def_efg_pct" },
  { key: "def_3pt_rate",     label: "Opp 3PT Rate", fmt: v => v?.toFixed(1), heat: "low",  rank: "rank_def_3pt_rate" },
  { key: "def_3pt_pct",      label: "Opp 3PT%",    fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_3pt_pct" },
  { key: "def_ftr",          label: "Opp FTR",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_ftr" },
  { key: "def_ft_pct",       label: "Opp FT%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_ft_pct", sectionEnd: true },
  /* Opp Ball Control */
  { key: "def_ast_rate",     label: "Opp AST Rate", fmt: v => v?.toFixed(1), heat: "low",  sectionStart: true, section: "Opp Ball Control",   rank: "rank_def_ast_rate" },
  { key: "def_or_pct",       label: "Opp OR%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_or_pct" },
  { key: "def_dr_pct",       label: "Opp DR%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_dr_pct" },
  { key: "def_off_to_pct",   label: "Opp TO%",     fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_def_off_to_pct" },
  { key: "def_stl_pct",      label: "Opp STL%",    fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_stl_pct" },
  { key: "def_blk_pct",      label: "Opp BLK%",    fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_blk_pct", sectionEnd: true },
  /* Opp Scoring Breakdown */
  { key: "def_to_pts_pct",   label: "Opp TO Pts %", fmt: v => v?.toFixed(1), heat: "low",  sectionStart: true, section: "Opp Scoring Breakdown", rank: "rank_def_to_pts_pct" },
  { key: "def_fb_pts_pct",   label: "Opp FSTBRK %", fmt: v => v?.toFixed(1), heat: "low",  rank: "rank_def_fb_pts_pct" },
  { key: "def_pip_pct",      label: "Opp Paint %",  fmt: v => v?.toFixed(1), heat: "low",  rank: "rank_def_pip_pct", sectionEnd: true },
  /* Adj DE */
  { key: "DefEff_srs",       label: "Adj DE",      fmt: v => v?.toFixed(2),  cls: v => v < 100 ? "eff-good" : v > 100 ? "eff-bad" : "", heat: "low", rank: "rank_def" },
];

let DATA = [];
let activeTab = "rank";   // "rank", "quad", "advOff", "advDef"
let sortCol = "rank_conf_standing";
let sortAsc = true;

function getCols() {
  if (activeTab === "quad") return QUAD_COLS;
  if (activeTab === "advOff") return ADV_OFF_COLS;
  if (activeTab === "advDef") return ADV_DEF_COLS;
  return RANK_COLS;
}

const params = new URLSearchParams(window.location.search);
const confName = params.get("conf");

if (!confName) {
  document.getElementById("confName").textContent = "No conference specified";
}

/* ---- fetch data ---- */
fetch("data.json")
  .then(r => r.json())
  .then(all => {
    /* populate conference dropdown */
    const allConfs = [...new Set(all.map(t => t.conference).filter(Boolean))].sort();
    const sel = document.getElementById("confSelect");
    allConfs.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      if (c === confName) opt.selected = true;
      sel.appendChild(opt);
    });
    sel.addEventListener("change", () => {
      if (sel.value) window.location.href = `conference.html?conf=${encodeURIComponent(sel.value)}`;
    });

    DATA = all.filter(t => t.conference === confName);
    if (DATA.length === 0) {
      document.getElementById("confName").textContent = `No teams found for "${confName}"`;
      return;
    }

    document.getElementById("confName").textContent = confName;
    document.title = `${confName} ‚Äî CBB Ratings 2025-26`;
    document.getElementById("teamCount").textContent = `${DATA.length} teams`;

    /* summary chips */
    const avgOE  = DATA.reduce((s, t) => s + (t.OffEff_srs || 0), 0) / DATA.length;
    const avgDE  = DATA.reduce((s, t) => s + (t.DefEff_srs || 0), 0) / DATA.length;
    const avgNet = DATA.reduce((s, t) => s + (t.net_srs || 0), 0) / DATA.length;
    const totalWab = DATA.reduce((s, t) => s + (t.season_wab || 0), 0);
    const inBracket = DATA.filter(t => t.bracket === "auto" || t.bracket === "at-large").length;
    const chips = [
      { label: "Avg Adj OE",  val: avgOE.toFixed(2) },
      { label: "Avg Adj DE",  val: avgDE.toFixed(2) },
      { label: "Avg AdjE",    val: (avgNet >= 0 ? "+" : "") + avgNet.toFixed(2) },
      { label: "Total WAB",   val: (totalWab >= 0 ? "+" : "") + totalWab.toFixed(1) },
      { label: "Bracket Teams", val: inBracket },
    ];
    document.getElementById("summary").innerHTML = chips.map(c =>
      `<div class="chip">${c.label}: <span class="val">${c.val}</span></div>`
    ).join("");

    buildHeader();
    render();

    /* build conference power rankings from ALL teams */
    buildConfPower(all);
  })
  .catch(e => {
    document.getElementById("confName").textContent = `Error: ${e}`;
  });

/* ---- heatmap helper ---- */
function heatColor(val, min, max, invert) {
  if (val == null || min === max) return "";
  let t = (val - min) / (max - min);
  if (invert) t = 1 - t;
  const r = Math.round(13 + (88 - 13) * t);
  const g = Math.round(27 + (166 - 27) * t);
  const b = Math.round(42 + (255 - 42) * t);
  return `rgba(${r},${g},${b},0.25)`;
}

/* ---- build header ---- */
function buildHeader() {
  const thead = document.getElementById("headerRow").parentElement;
  thead.innerHTML = "";
  const COLS = getCols();
  const hasSections = COLS.some(c => c.section);

  // Section header row for tabs with grouped sections
  if (hasSections) {
    const sectionRow = document.createElement("tr");
    let leadCols = 0;
    for (const c of COLS) { if (!c.section) leadCols++; else break; }
    if (leadCols > 0) {
      const blankTh = document.createElement("th");
      blankTh.setAttribute("colspan", leadCols);
      blankTh.style.borderBottom = "none";
      sectionRow.appendChild(blankTh);
    }
    let curSection = null, curSpan = 0, sections = [], sectionClosed = false;
    COLS.slice(leadCols).forEach(c => {
      if (c.section && c.section !== curSection) {
        if (curSection !== null) sections.push({ label: curSection, span: curSpan });
        else if (sectionClosed && curSpan > 0) sections.push({ label: "", span: curSpan });
        curSection = c.section;
        curSpan = 0;
        sectionClosed = false;
      }
      curSpan++;
      if (c.sectionEnd) {
        sections.push({ label: curSection, span: curSpan });
        curSection = null;
        curSpan = 0;
        sectionClosed = true;
      }
    });
    if (curSection !== null) sections.push({ label: curSection, span: curSpan });
    else if (curSpan > 0) sections.push({ label: "", span: curSpan });
    sections.forEach(s => {
      const th = document.createElement("th");
      th.setAttribute("colspan", s.span);
      if (s.label) {
        th.style.background = "rgba(88,166,255,.06)";
        th.style.color = "var(--text-dim)";
        th.style.fontSize = ".7rem";
        th.style.fontWeight = "700";
        th.style.textTransform = "uppercase";
        th.style.letterSpacing = ".05em";
        th.style.borderBottom = "2px solid var(--accent)";
        th.style.padding = "3px 7px";
        th.textContent = s.label;
      } else {
        th.style.borderBottom = "none";
      }
      sectionRow.appendChild(th);
    });
    thead.appendChild(sectionRow);
  }

  const tr = document.createElement("tr");
  tr.id = "headerRow";
  COLS.forEach(c => {
    const th = document.createElement("th");
    th.textContent = c.label;
    th.style.textAlign = c.align || "center";
    if (c.sectionStart) th.classList.add("section-start");
    if (c.sectionEnd) th.classList.add("section-end");
    if (c.width) th.style.width = c.width;
    th.addEventListener("click", () => {
      if (sortCol === c.key) sortAsc = !sortAsc;
      else { sortCol = c.key; sortAsc = c.key === "team_displayName"; }
      render();
    });
    tr.appendChild(th);
  });
  thead.appendChild(tr);
}

/* ---- render table ---- */
function render() {
  const COLS = getCols();
  let rows = [...DATA].sort((a, b) => {
    const colDef = COLS.find(c => c.key === sortCol);
    const sk = colDef?.sortKey || (sortCol === "_rank" ? colDef?.rankKey : null) || sortCol;
    let va = a[sk], vb = b[sk];
    if (va == null) return 1; if (vb == null) return -1;
    if (typeof va === "string") { va = va.toLowerCase(); vb = (vb || "").toLowerCase(); }
    return sortAsc ? (va > vb ? 1 : va < vb ? -1 : 0) : (va < vb ? 1 : va > vb ? -1 : 0);
  });

  const bounds = {};
  COLS.forEach(c => {
    if (!c.heat) return;
    const vals = rows.map(r => r[c.key]).filter(v => v != null);
    if (vals.length) { bounds[c.key] = { min: Math.min(...vals), max: Math.max(...vals) }; }
  });

  const tbody = document.getElementById("tbody");
  const frags = [];
  rows.forEach((r, i) => {
    const cells = COLS.map(c => {
      const v = c.key === "_rank" ? r[c.rankKey || "rank_net"] : r[c.key];
      let display = v != null ? c.fmt(v) : "‚Äì";
      if (c.key === "team_displayName" && r.team_abbr) {
        const mIcon = r.momentum_l5 >= 90 ? " üî•" : r.momentum_l5 <= 10 ? " ‚ùÑÔ∏è" : "";
        display = `<a href="team.html?team=${encodeURIComponent(r.team_abbr)}" style="color:var(--accent);text-decoration:none">${display}</a>${mIcon}`;
      }
      if (c.rank && r[c.rank] != null) {
        display += `<span class="rk">${r[c.rank]}</span>`;
      }
      const cls = c.cls ? c.cls(v) : "";
      const align = c.align || "center";
      let style = `text-align:${align}`;
      if (c.heat && v != null && bounds[c.key]) {
        const bg = heatColor(v, bounds[c.key].min, bounds[c.key].max, c.heat === "low");
        if (bg) style += `;background:${bg}`;
      }
      return `<td style="${style}" class="${cls} ${c.heat ? 'heatmap' : ''} ${c.sectionStart ? 'section-start' : ''} ${c.sectionEnd ? 'section-end' : ''}">${display}</td>`;
    }).join("");
    frags.push(`<tr>${cells}</tr>`);
  });
  tbody.innerHTML = frags.join("");

  document.querySelectorAll("#headerRow th").forEach((th, i) => {
    const col = COLS[i];
    const arrow = col.key === sortCol ? (sortAsc ? " ‚ñ≤" : " ‚ñº") : "";
    th.textContent = col.label + arrow;
  });
}

/* ---- tab switching ---- */
function switchTab(tab, col, asc) {
  if (activeTab === tab) return;
  gtag('event', 'tab_click', { event_category: 'navigation', event_label: tab, page: 'conference' });
  activeTab = tab;
  sortCol = col; sortAsc = asc;
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById("tab" + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add("active");
  document.getElementById("mainTable").classList.toggle("adv-mode", tab === "advOff" || tab === "advDef");
  buildHeader();
  render();
}
document.getElementById("tabRank").addEventListener("click", () => switchTab("rank", "rank_conf_standing", true));
document.getElementById("tabQuad").addEventListener("click", () => switchTab("quad", "season_wab", false));
document.getElementById("tabAdvOff").addEventListener("click", () => switchTab("advOff", "OffEff_srs", false));
document.getElementById("tabAdvDef").addEventListener("click", () => switchTab("advDef", "DefEff_srs", true));

/* ---- Conference Power Rankings ---- */
let ALL_DATA = [];
let confPowerSortCol = "avg_net";
let confPowerSortAsc = false;

const CONF_POWER_COLS = [
  { key: "_rank",       label: "#",           align: "center" },
  { key: "conference",  label: "Conference",  align: "left" },
  { key: "teams",       label: "Teams",       align: "center" },
  { key: "tourney",     label: "Tourney Teams", align: "center" },
  { key: "avg_oe",      label: "Avg OE",      align: "center", fmt: v => v?.toFixed(2) },
  { key: "avg_de",      label: "Avg DE",      align: "center", fmt: v => v?.toFixed(2) },
  { key: "avg_net",     label: "Avg AdjE",    align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2) },
  { key: "total_wab",   label: "Total WAB",   align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1) },
  { key: "avg_sos",     label: "Avg SOS",     align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2) },
  { key: "best_team",   label: "Best Team",   align: "left" },
];

function buildConfPower(allTeams) {
  ALL_DATA = allTeams;

  /* group by conference */
  const confMap = {};
  allTeams.forEach(t => {
    const c = t.conference;
    if (!c) return;
    if (!confMap[c]) confMap[c] = [];
    confMap[c].push(t);
  });

  /* compute aggregates */
  const confRows = Object.entries(confMap).map(([conf, teams]) => {
    const n = teams.length;
    const avgOE  = teams.reduce((s, t) => s + (t.OffEff_srs || 0), 0) / n;
    const avgDE  = teams.reduce((s, t) => s + (t.DefEff_srs || 0), 0) / n;
    const avgNet = teams.reduce((s, t) => s + (t.net_srs || 0), 0) / n;
    const totalWab = teams.reduce((s, t) => s + (t.season_wab || 0), 0);
    const avgSos = teams.reduce((s, t) => s + (t.sos || 0), 0) / n;
    const tourney = teams.filter(t => t.bracket === "auto" || t.bracket === "at-large").length;
    const best = teams.reduce((a, b) => (a.net_srs || 0) > (b.net_srs || 0) ? a : b);
    return {
      conference: conf,
      teams: n,
      tourney,
      avg_oe: avgOE,
      avg_de: avgDE,
      avg_net: avgNet,
      total_wab: totalWab,
      avg_sos: avgSos,
      best_team: best.team_displayName,
      best_abbr: best.team_abbr,
    };
  });

  renderConfPower(confRows);
}

function renderConfPower(confRows) {
  /* sort */
  const sorted = [...confRows].sort((a, b) => {
    let va = a[confPowerSortCol], vb = b[confPowerSortCol];
    if (va == null) return 1; if (vb == null) return -1;
    if (typeof va === "string") { va = va.toLowerCase(); vb = (vb || "").toLowerCase(); }
    return confPowerSortAsc ? (va > vb ? 1 : va < vb ? -1 : 0) : (va < vb ? 1 : va > vb ? -1 : 0);
  });

  /* header */
  const thead = document.getElementById("confPowerHeader");
  thead.innerHTML = "";
  CONF_POWER_COLS.forEach(c => {
    const th = document.createElement("th");
    const arrow = c.key === confPowerSortCol ? (confPowerSortAsc ? " ‚ñ≤" : " ‚ñº") : "";
    th.textContent = c.label + arrow;
    th.style.textAlign = c.align || "center";
    if (c.key !== "_rank") {
      th.addEventListener("click", () => {
        if (confPowerSortCol === c.key) confPowerSortAsc = !confPowerSortAsc;
        else { confPowerSortCol = c.key; confPowerSortAsc = c.key === "conference"; }
        renderConfPower(confRows);
      });
    }
    thead.appendChild(th);
  });

  /* heatmap bounds */
  const heatCols = ["avg_oe", "avg_de", "avg_net", "total_wab", "avg_sos"];
  const bounds = {};
  heatCols.forEach(k => {
    const vals = sorted.map(r => r[k]).filter(v => v != null);
    if (vals.length) bounds[k] = { min: Math.min(...vals), max: Math.max(...vals) };
  });
  function confHeat(k, v) {
    if (v == null || !bounds[k]) return "";
    const b = bounds[k];
    if (b.min === b.max) return "";
    let t = (v - b.min) / (b.max - b.min);
    if (k === "avg_de") t = 1 - t; // lower DE = better
    const r = Math.round(13 + (88 - 13) * t);
    const g = Math.round(27 + (166 - 27) * t);
    const bb = Math.round(42 + (255 - 42) * t);
    return `rgba(${r},${g},${bb},0.25)`;
  }

  /* rows */
  const tbody = document.getElementById("confPowerTbody");
  const frags = [];
  sorted.forEach((r, i) => {
    const isCurrent = r.conference === confName;
    const cls = isCurrent ? ' class="current-conf"' : '';
    const cells = CONF_POWER_COLS.map(c => {
      let display, style = `text-align:${c.align || "center"}`;
      let tdCls = "";

      if (c.key === "_rank") {
        display = i + 1;
      } else if (c.key === "conference") {
        display = `<a href="conference.html?conf=${encodeURIComponent(r.conference)}">${r.conference}</a>`;
        tdCls = "conf-name-cell";
      } else if (c.key === "best_team") {
        display = `<a href="team.html?team=${encodeURIComponent(r.best_abbr)}" style="color:var(--accent);text-decoration:none">${r.best_team}</a>`;
        tdCls = "conf-name-cell";
      } else if (c.key === "tourney") {
        display = r.tourney > 0 ? r.tourney : "‚Äì";
      } else {
        const v = r[c.key];
        display = c.fmt ? c.fmt(v) : (v ?? "‚Äì");
        const bg = confHeat(c.key, v);
        if (bg) style += `;background:${bg}`;
        // color for net/wab
        if ((c.key === "avg_net" || c.key === "total_wab" || c.key === "avg_sos") && v != null) {
          style += `;color:${v > 0 ? "var(--green)" : v < 0 ? "var(--red)" : "var(--text)"}`;
          if (v > 0 && c.key === "avg_net") style += `;font-weight:600`;
        }
      }
      return `<td class="${tdCls}" style="${style}">${display}</td>`;
    }).join("");
    frags.push(`<tr${cls}>${cells}</tr>`);
  });
  tbody.innerHTML = frags.join("");
}
</script>
</body>
</html>
