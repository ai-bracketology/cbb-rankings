<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<script>
  // Apply saved theme immediately to prevent flash
  (function(){
    var t = localStorage.getItem("cbb_theme");
    if (t === "light") document.documentElement.setAttribute("data-theme","light");
  })();
  /* reload when restored from bfcache (back/forward navigation) */
  window.addEventListener("pageshow", function(e) {
    if (e.persisted) window.location.reload();
  });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIB College Basketball Ratings 2025-26</title>
<style>
  :root {
  /* bubble teams (first/next 4 out) */
  .bubble-section {
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 20px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  @media (max-width: 600px) {
    .bubble-section {
      grid-template-columns: 1fr;
    }
  }
    --bg:        #0d1117;
    --surface:   #161b22;
    --border:    #30363d;
    --text:      #c9d1d9;
    --text-dim:  #8b949e;
    --accent:    #58a6ff;
    --green:     #3fb950;
    --red:       #f85149;
    --gold:      #d29922;
  }
  html[data-theme="light"] {
    --bg:        #ffffff;
    --surface:   #f6f8fa;
    --border:    #d0d7de;
    --text:      #1f2328;
    --text-dim:  #656d76;
    --accent:    #0969da;
    --green:     #1a7f37;
    --red:       #cf222e;
    --gold:      #9a6700;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
  }

  /* ---------- header ---------- */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 24px 32px;
    text-align: center;
  }
  header h1 { font-size: 1.6rem; font-weight: 600; }
  header p  { color: var(--text-dim); font-size: .85rem; margin-top: 4px; }
  .header-actions { margin-top: 10px; }
  .header-actions a {
    display: inline-block;
    background: var(--accent);
    color: #fff;
    font-weight: 600;
    font-size: .82rem;
    padding: 6px 16px;
    border-radius: 6px;
    text-decoration: none;
    transition: opacity .15s;
  }
  .header-actions a:hover { opacity: .85; }

  /* ---------- theme toggle ---------- */
  .theme-toggle {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 1.1rem;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: border-color .15s;
    line-height: 1;
    vertical-align: middle;
    margin-left: 6px;
  }
  .theme-toggle:hover { border-color: var(--accent); }

  /* ---------- controls ---------- */
  .controls {
    max-width: 1400px;
    margin: 20px auto 0;
    padding: 0 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  .controls input[type="text"] {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 12px;
    font-size: .9rem;
    width: 280px;
    outline: none;
  }
  .controls input[type="text"]:focus { border-color: var(--accent); }
  .controls .stat-count {
    color: var(--text-dim);
    font-size: .82rem;
    margin-left: auto;
  }

  /* ---------- table wrapper ---------- */
  .table-wrap {
    max-width: 1400px;
    margin: 16px auto 40px;
    padding: 0 20px;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: .82rem;
  }
  thead { position: sticky; top: 0; z-index: 2; }
  thead th {
    background: var(--surface);
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    padding: 10px 8px;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    text-align: center;
  }
  thead th:hover { color: var(--accent); }
  thead th .arrow { font-size: .65rem; margin-left: 3px; }

  tbody tr { border-bottom: 1px solid var(--border); }
  tbody tr:hover { background: rgba(88,166,255,.06); }
  tbody td {
    padding: 8px 8px;
    white-space: nowrap;
    text-align: center;
  }
  tbody td:first-child { color: var(--text-dim); }
  tbody td:nth-child(2) { font-weight: 500; }

  /* colour-coded efficiency cells */
  .eff-good { color: var(--green); }
  .eff-bad  { color: var(--red); }
  .net-pos  { color: var(--green); font-weight: 600; }
  .net-neg  { color: var(--red); }

  /* heatmap cell */
  .heatmap  { border-radius: 4px; }

  /* section divider for grouped columns */
  .section-start {
    border-left: 2px solid var(--accent) !important;
  }
  .section-end {
    border-right: 2px solid var(--accent) !important;
  }

  /* compact advanced-stats mode */
  table.adv-mode { table-layout: fixed; }
  table.adv-mode thead th {
    white-space: normal;
    word-break: break-word;
    font-size: .72rem;
    padding: 8px 4px;
    line-height: 1.25;
  }
  table.adv-mode tbody td {
    font-size: .78rem;
    padding: 6px 4px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* inline rank badge */
  .rk {
    display: inline-block;
    font-size: .65rem;
    color: var(--text-dim);
    margin-left: 4px;
    vertical-align: super;
    opacity: .75;
  }

  /* pill badges for ranks */
  .rank-pill {
    display: inline-block;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1px 7px;
    font-size: .72rem;
    color: var(--text-dim);
    margin-left: 4px;
  }

  /* responsive */
  @media (max-width: 768px) {
    .controls { flex-direction: column; align-items: stretch; }
    .controls input[type="text"] { width: 100%; }
    .controls .stat-count { margin-left: 0; }
    .table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    table.adv-mode {
      min-width: 1100px;
      font-size: 0.72rem;
    }
    table.adv-mode thead th, table.adv-mode tbody td {
      padding: 4px 2px;
      font-size: 0.72rem;
    }
    table.adv-mode thead th {
      white-space: normal;
      word-break: break-word;
    }
    table.adv-mode tbody td {
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }

  /* footer */
  footer {
    text-align: center;
    padding: 24px;
    color: var(--text-dim);
    font-size: .75rem;
    border-top: 1px solid var(--border);
  }
  footer a { color: var(--accent); text-decoration: none; }

  /* ---------- tabs ---------- */
  .tabs {
    max-width: 1400px;
    margin: 20px auto 0;
    padding: 0 20px;
    display: flex;
    gap: 4px;
  }
  .tab-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    color: var(--text-dim);
    padding: 9px 20px;
    font-size: .85rem;
    font-weight: 600;
    cursor: pointer;
    transition: color .15s, border-color .15s;
  }
  .tab-btn:hover { color: var(--text); }
  .tab-btn.active {
    color: var(--accent);
    border-color: var(--accent);
    background: var(--bg);
  }

  /* ---------- bracket grid ---------- */
  .bracket-wrap {
    max-width: 1400px;
    margin: 16px auto 40px;
    padding: 0 20px;
    display: none;          /* shown only on brack tab */
  }
  .bracket-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }
  .bracket-col {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .bracket-col-header {
    background: rgba(88,166,255,.08);
    padding: 8px 12px;
    font-weight: 700;
    font-size: .8rem;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: .04em;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
  }
  .bracket-col-header span:last-child {
    font-size: .7rem;
    color: var(--text-dim);
    letter-spacing: 0;
    text-transform: none;
    display: flex;
    gap: 12px;
  }
  .bracket-row {
    display: flex;
    align-items: center;
    padding: 5px 10px;
    border-bottom: 1px solid var(--border);
    font-size: .82rem;
    gap: 5px;
    transition: background .12s;
  }
  .bracket-row:last-child { border-bottom: none; }
  .bracket-row:hover { background: rgba(88,166,255,.06); }
  .bracket-seed {
    width: 20px;
    font-weight: 700;
    color: var(--text-dim);
    text-align: center;
    flex-shrink: 0;
    font-size: .78rem;
  }
  .bracket-team {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .bracket-team a {
    color: var(--text);
    text-decoration: none;
    font-weight: 500;
  }
  .bracket-team a:hover { color: var(--accent); }
  .bracket-bid {
    font-size: .62rem;
    padding: 1px 4px;
    border-radius: 8px;
    font-weight: 600;
    flex-shrink: 0;
  }
  .bracket-bid.auto {
    background: rgba(63,185,80,.15);
    color: var(--green);
  }
  .bracket-bid.at-large {
    background: rgba(210,153,34,.15);
    color: var(--gold);
  }
  .l4-badge {
    font-size: .6rem;
    padding: 1px 4px;
    border-radius: 6px;
    font-weight: 700;
    background: rgba(248,81,73,.15);
    color: var(--red);
    margin-left: 4px;
    vertical-align: middle;
  }
  .bracket-stat {
    width: 36px;
    text-align: right;
    font-size: .72rem;
    color: var(--text-dim);
    flex-shrink: 0;
    font-variant-numeric: tabular-nums;
  }

  /* seed-line group box */
  .seed-group {
    display: flex;
    align-items: stretch;
    border: 1px solid var(--border);
    border-radius: 6px;
    margin: 4px 6px;
    overflow: hidden;
    background: rgba(88,166,255,.03);
  }
  .seed-group-label {
    display: flex;
    align-items: center;
    justify-content: center;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    padding: 4px 5px;
    font-size: .68rem;
    font-weight: 700;
    color: var(--accent);
    background: rgba(88,166,255,.08);
    border-right: 1px solid var(--border);
    white-space: nowrap;
    letter-spacing: .03em;
    min-width: 22px;
    text-transform: uppercase;
  }
  .seed-group-teams {
    flex: 1;
    min-width: 0;
  }
  .seed-group .bracket-row {
    border-bottom: 1px solid rgba(48,54,61,.5);
    margin: 0;
  }
  .seed-group .bracket-row:last-child { border-bottom: none; }

  /* bubble teams (first/next 4 out) */
  .bubble-section {
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 20px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  .bubble-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .bubble-header {
    padding: 8px 14px;
    font-weight: 700;
    font-size: .82rem;
    text-transform: uppercase;
    letter-spacing: .04em;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
  }
  .bubble-header.first-out {
    color: var(--red);
    background: rgba(248,81,73,.08);
  }
  .bubble-header.next-out {
    color: var(--text-dim);
    background: rgba(139,148,158,.08);
  }
  .bubble-header span:last-child {
    font-size: .7rem;
    color: var(--text-dim);
    letter-spacing: 0;
    text-transform: none;
    display: flex;
    gap: 12px;
  }

  @media (max-width: 1000px) {
    .bracket-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 550px) {
    .bracket-grid { grid-template-columns: 1fr; }
  }

  /* ---------- bubble watch status labels ---------- */
  .bubble-in   { color: var(--green); font-weight: 600; }
  .bubble-aq   { color: var(--green); font-weight: 600; }
  .bubble-f4o  { color: var(--gold); font-weight: 600; }
  .bubble-out  { color: var(--red); }

  /* ---------- seed odds tab ---------- */
  .seed-odds-wrap {
    display: none;
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 20px;
  }
  .seed-odds-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .seed-odds-controls input[type="text"] {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 12px;
    font-size: .9rem;
    width: 280px;
    outline: none;
  }
  .seed-odds-controls input[type="text"]:focus { border-color: var(--accent); }
  .seed-odds-table-wrap { overflow-x: auto; }
  .seed-odds-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .8rem;
  }
  .seed-odds-table thead th {
    background: var(--surface);
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    padding: 8px 6px;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .seed-odds-table thead th:hover { color: var(--accent); }
  .seed-odds-table td {
    padding: 5px 6px;
    border-bottom: 1px solid var(--border);
    text-align: center;
    white-space: nowrap;
  }
  .seed-odds-table td.team-cell {
    text-align: left;
    font-weight: 500;
  }
  .seed-odds-table td.team-cell a {
    color: var(--accent);
    text-decoration: none;
  }
  .seed-odds-table td.team-cell a:hover { text-decoration: underline; }
  .seed-odds-table td.conf-cell { text-align: left; }
  .seed-odds-table td.conf-cell a {
    color: var(--accent);
    text-decoration: none;
  }
  .seed-odds-table tbody tr:hover { background: rgba(88,166,255,.06); }

  /* ---------- comparison tool tab ---------- */
  .compare-wrap {
    display: none;
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 20px;
  }
  .compare-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 14px;
    position: relative;
  }
  .compare-controls input[type="text"] {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 12px;
    font-size: .9rem;
    width: 300px;
    outline: none;
  }
  .compare-controls input[type="text"]:focus { border-color: var(--accent); }
  .compare-autocomplete {
    position: absolute;
    top: 100%;
    left: 0;
    width: 300px;
    max-height: 240px;
    overflow-y: auto;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0 0 6px 6px;
    z-index: 100;
    display: none;
  }
  .compare-autocomplete div {
    padding: 8px 12px;
    cursor: pointer;
    font-size: .85rem;
    color: var(--text);
    display: flex;
    justify-content: space-between;
  }
  .compare-autocomplete div:hover { background: rgba(88,166,255,.12); }
  .compare-autocomplete div .ac-conf { color: var(--text-dim); font-size: .75rem; }

  .compare-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
  }
  .compare-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: 16px;
    padding: 4px 10px 4px 12px;
    font-size: .8rem;
    color: var(--accent);
    font-weight: 600;
  }
  .compare-tag .remove-tag {
    cursor: pointer;
    color: var(--text-dim);
    font-size: .9rem;
    line-height: 1;
    margin-left: 2px;
  }
  .compare-tag .remove-tag:hover { color: var(--red); }
  .compare-clear {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-dim);
    padding: 4px 10px;
    font-size: .75rem;
    cursor: pointer;
  }
  .compare-clear:hover { color: var(--red); border-color: var(--red); }

  .compare-table-wrap { overflow-x: auto; }
  .compare-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .82rem;
  }
  .compare-table thead th {
    background: var(--surface);
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    padding: 10px 8px;
    white-space: nowrap;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .compare-table td {
    padding: 8px 8px;
    border-bottom: 1px solid var(--border);
    text-align: center;
    white-space: nowrap;
  }
  .compare-table td.team-cell {
    text-align: left;
    font-weight: 500;
  }
  .compare-table td.team-cell a {
    color: var(--accent);
    text-decoration: none;
  }
  .compare-table td.team-cell a:hover { text-decoration: underline; }
  .compare-table tbody tr:hover { background: rgba(88,166,255,.06); }
  .compare-table .best-val { font-weight: 700; color: var(--green); }

  /* game list cells (best wins / worst losses) */
  .compare-table td.game-list-cell {
    white-space: normal;
    min-width: 180px;
    vertical-align: top;
    padding: 6px 8px;
  }
  .game-list-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: .78rem;
    line-height: 1.6;
  }
  .game-list-rank {
    color: var(--text-dim);
    font-size: .72rem;
    min-width: 42px;
    text-align: right;
  }
  .game-list-link {
    color: var(--accent);
    text-decoration: none;
  }
  .game-list-link:hover { text-decoration: underline; }
  .game-list-none {
    color: var(--text-dim);
    font-style: italic;
    font-size: .78rem;
  }

  .compare-empty {
    text-align: center;
    color: var(--text-dim);
    padding: 40px 20px;
    font-size: .95rem;
  }

  /* ---------- mobile responsive ---------- */
  @media (max-width: 768px) {
    header { padding: 16px 16px; }
    header h1 { font-size: 1.15rem; }
    header p { font-size: .75rem; }
    .header-actions { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .header-actions a { font-size: .75rem; padding: 5px 12px; }

    .tabs {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      flex-wrap: nowrap;
      padding: 0 12px;
      gap: 2px;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab-btn {
      padding: 7px 12px;
      font-size: .73rem;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .bracket-wrap { padding: 0 12px; }
    .bubble-section { padding: 0 12px; }

    .seed-odds-wrap { padding: 0 12px; }
    .seed-odds-controls { padding: 0; }
    .seed-odds-controls input[type="text"] { width: 100%; }
    .seed-odds-table { font-size: .7rem; }
    .seed-odds-table thead th { padding: 6px 4px; font-size: .65rem; }
    .seed-odds-table td { padding: 4px 3px; }

    .compare-wrap { padding: 0 12px; }
    .compare-controls input[type="text"] { width: 100%; }
    .compare-autocomplete { width: 100%; }
    .compare-table { font-size: .72rem; }
    .compare-table thead th { padding: 7px 4px; font-size: .68rem; }
    .compare-table td { padding: 6px 4px; }
    .compare-table td.game-list-cell { min-width: 150px; }
    .game-list-item { font-size: .68rem; }
    .game-list-rank { font-size: .64rem; min-width: 22px; }
  }
</style>
</head>
<body>

<header>
  <h1>üèÄü§ñ AIB College Basketball Ratings ‚Äî 2025-26</h1>
  <p>Opponent-adjusted efficiency ratings and resume ratings ¬∑ Not actually AI ¬∑ Updated through Feb 22, 2026</p>
  <div class="header-actions">
    <a href="game_date.html" id="latestGamesBtn">üìä Latest Game Results</a>
    <a href="blog.html" id="blogBtn">üìù Blog</a>
    <button class="theme-toggle" id="themeToggle" title="Toggle light/dark mode">üåô</button>
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" id="tabRank">Team Rankings</button>
  <button class="tab-btn" id="tabQuad">Quadrant Records</button>
  <button class="tab-btn" id="tabAdvOff">Adv Offensive</button>
  <button class="tab-btn" id="tabAdvDef">Adv Defensive</button>
  <button class="tab-btn" id="tabBrack">Bracketology</button>
  <button class="tab-btn" id="tabBubble">Bubble Watch</button>
  <button class="tab-btn" id="tabSeedOdds">Seed Odds</button>
  <button class="tab-btn" id="tabCompare">Comparison Tool</button>
</div>

<div class="controls">
  <input type="text" id="search" placeholder="Search teams‚Ä¶" autocomplete="off">
  <span class="stat-count" id="rowCount"></span>
</div>

<div class="table-wrap">
  <table id="mainTable">
    <thead>
      <tr id="headerRow"></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="bracket-wrap" id="bracketWrap">
  <div class="bracket-grid" id="bracketGrid"></div>
  <div class="bubble-section" id="bubbleSection"></div>
</div>

<div class="seed-odds-wrap" id="seedOddsWrap">
  <div class="seed-odds-controls">
    <input type="text" id="seedOddsSearch" placeholder="Search teams‚Ä¶" autocomplete="off">
    <span class="stat-count" id="seedOddsCount"></span>
  </div>
  <div class="seed-odds-table-wrap">
    <table class="seed-odds-table" id="seedOddsTable">
      <thead><tr id="seedOddsHeader"></tr></thead>
      <tbody id="seedOddsTbody"></tbody>
    </table>
  </div>
</div>

<div class="compare-wrap" id="compareWrap">
  <div class="compare-controls">
    <input type="text" id="compareSearch" placeholder="Search and add teams‚Ä¶" autocomplete="off">
    <div class="compare-autocomplete" id="compareAutocomplete"></div>
  </div>
  <div class="compare-tags" id="compareTags"></div>
  <div class="compare-table-wrap">
    <table class="compare-table" id="compareTable">
      <thead><tr id="compareHeader"></tr></thead>
      <tbody id="compareTbody"></tbody>
    </table>
    <div class="compare-empty" id="compareEmpty">Search for teams above to compare resumes side-by-side</div>
  </div>
</div>

<footer>
  Built by <a href="https://github.com/ai-bracketology">AI Bracketology</a> ¬∑ Data sourced from ESPN
</footer>

<script>
/* ---- theme toggle ---- */
(function initThemeToggle() {
  const btn = document.getElementById("themeToggle");
  const isLight = document.documentElement.getAttribute("data-theme") === "light";
  btn.textContent = isLight ? "‚òÄÔ∏è" : "üåô";
  btn.addEventListener("click", () => {
    const nowLight = document.documentElement.getAttribute("data-theme") === "light";
    if (nowLight) {
      document.documentElement.removeAttribute("data-theme");
      localStorage.setItem("cbb_theme", "dark");
      btn.textContent = "üåô";
    } else {
      document.documentElement.setAttribute("data-theme", "light");
      localStorage.setItem("cbb_theme", "light");
      btn.textContent = "‚òÄÔ∏è";
    }
  });
})();

/* ---- column definitions ---- */

/* Tab 1: Team Rankings ‚Äî Efficiency + Resume sections */
const RANK_COLS = [
  { key: "_rank",            label: "#",            fmt: v => v,              align: "center", rankKey: "rank_net" },
  { key: "team_displayName", label: "Team",         fmt: v => v,              align: "left" },
  { key: "proj_seed",        label: "Proj Seed",    fmt: v => v ?? "",        align: "center" },
  { key: "conference",       label: "Conf",         fmt: v => v ?? "‚Äì",       align: "left" },
  { key: "record",           label: "Record",       fmt: v => v ?? "‚Äì",       align: "center" },
  { key: "conf_record",      label: "Conf",         fmt: v => v ?? "‚Äì",       align: "center" },
  { key: "streak",           label: "Streak",       fmt: v => v ?? "‚Äì",       align: "center", sortKey: "streak_num", cls: v => v?.[0] === "W" ? "net-pos" : v?.[0] === "L" ? "net-neg" : "" },
  /* Efficiency */
  { key: "Tempo_srs",        label: "Adj T",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_tempo", sectionStart: true, section: "Efficiency" },
  { key: "OffEff_srs",       label: "Adj OE",       fmt: v => v?.toFixed(2),  cls: v => v > 100 ? "eff-good" : v < 100 ? "eff-bad" : "", heat: "high", rank: "rank_off" },
  { key: "DefEff_srs",       label: "Adj DE",       fmt: v => v?.toFixed(2),  cls: v => v < 100 ? "eff-good" : v > 100 ? "eff-bad" : "", heat: "low",  rank: "rank_def" },
  { key: "net_srs",          label: "Total AdjE",   fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_net", sectionEnd: true },
  /* Resume */
  { key: "sos",              label: "SOS",           fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_sos",    sectionStart: true, section: "Resume" },
  { key: "nc_sos",           label: "NC SOS",        fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_nc_sos" },
  { key: "season_wab",       label: "WAB",           fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_wab" },
  { key: "slct",             label: "SLCT",          fmt: v => v?.toFixed(2),  heat: "high", rank: "rank_slct" },
  { key: "seed",             label: "SEED",          fmt: v => v?.toFixed(2),  heat: "high", rank: "rank_seed", sectionEnd: true },
];

/* Tab 3: Quadrant Records ‚Äî sorted by WAB rank */
const QUAD_COLS = [
  { key: "_rank",            label: "#",            fmt: v => v,              align: "center", rankKey: "rank_wab" },
  { key: "team_displayName", label: "Team",         fmt: v => v,              align: "left" },
  { key: "proj_seed",        label: "Proj Seed",    fmt: v => v ?? "",        align: "center" },
  { key: "conference",       label: "Conf",         fmt: v => v ?? "‚Äì",       align: "left" },
  { key: "record",           label: "Record",       fmt: v => v ?? "‚Äì",       align: "center" },
  { key: "q1a_record",       label: "Q1A",          fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q1a_w" },
  { key: "q1_record",        label: "Q1",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q1_w" },
  { key: "q2_record",        label: "Q2",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q2_w" },
  { key: "q12_record",       label: "Q1+Q2",        fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q12_w" },
  { key: "q3_record",        label: "Q3",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q3_w" },
  { key: "q4_record",        label: "Q4",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q4_w" },
  { key: "season_wab",       label: "WAB",          fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_wab" },
];

/* Tab 4: Advanced Offensive Stats ‚Äî sorted by Adj OE rank */
const ADV_OFF_COLS = [
  { key: "_rank",            label: "#",           fmt: v => v,              align: "center", rankKey: "rank_off", width: "36px" },
  { key: "team_displayName", label: "Team",        fmt: v => v,              align: "left",   width: "160px" },
  { key: "conference",       label: "Conf",        fmt: v => v ?? "‚Äì",       align: "left",   width: "100px" },
  /* Shooting */
  { key: "adv_efg_pct",      label: "eFG%",        fmt: v => v?.toFixed(1),  heat: "high", sectionStart: true, section: "Shooting",       rank: "rank_adv_efg_pct" },
  { key: "adv_3pt_rate",     label: "3PT Rate",    fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_3pt_rate" },
  { key: "adv_3pt_pct",      label: "3PT%",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_3pt_pct" },
  { key: "adv_ftr",          label: "FTR",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_ftr" },
  { key: "adv_ft_pct",       label: "FT%",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_ft_pct", sectionEnd: true },
  /* Ball Control */
  { key: "adv_ast_rate",     label: "AST Rate",    fmt: v => v?.toFixed(1),  heat: "high", sectionStart: true, section: "Ball Control",   rank: "rank_adv_ast_rate" },
  { key: "adv_or_pct",       label: "OR%",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_or_pct" },
  { key: "adv_dr_pct",       label: "DR%",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_dr_pct" },
  { key: "adv_off_to_pct",   label: "Off TO%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_adv_off_to_pct" },
  { key: "adv_stl_pct",      label: "STL%",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_stl_pct" },
  { key: "adv_blk_pct",      label: "BLK%",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_blk_pct", sectionEnd: true },
  /* Scoring Breakdown */
  { key: "adv_to_pts_pct",   label: "TO Pts %",    fmt: v => v?.toFixed(1),  heat: "high", sectionStart: true, section: "Scoring Breakdown", rank: "rank_adv_to_pts_pct" },
  { key: "adv_fb_pts_pct",   label: "FSTBRK %",    fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_fb_pts_pct" },
  { key: "adv_pip_pct",      label: "Paint %",     fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_pip_pct", sectionEnd: true },
  /* Adj OE */
  { key: "OffEff_srs",       label: "Adj OE",      fmt: v => v?.toFixed(2),  cls: v => v > 100 ? "eff-good" : v < 100 ? "eff-bad" : "", heat: "high", rank: "rank_off" },
];

/* Tab 5: Advanced Defensive Stats ‚Äî sorted by Adj DE rank */
const ADV_DEF_COLS = [
  { key: "_rank",            label: "#",           fmt: v => v,              align: "center", rankKey: "rank_def", width: "36px" },
  { key: "team_displayName", label: "Team",        fmt: v => v,              align: "left",   width: "160px" },
  { key: "conference",       label: "Conf",        fmt: v => v ?? "‚Äì",       align: "left",   width: "100px" },
  /* Opp Shooting */
  { key: "def_efg_pct",      label: "Opp eFG%",    fmt: v => v?.toFixed(1),  heat: "low",  sectionStart: true, section: "Opp Shooting",       rank: "rank_def_efg_pct" },
  { key: "def_3pt_rate",     label: "Opp 3PT Rate", fmt: v => v?.toFixed(1), heat: "low",  rank: "rank_def_3pt_rate" },
  { key: "def_3pt_pct",      label: "Opp 3PT%",    fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_3pt_pct" },
  { key: "def_ftr",          label: "Opp FTR",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_ftr" },
  { key: "def_ft_pct",       label: "Opp FT%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_ft_pct", sectionEnd: true },
  /* Opp Ball Control */
  { key: "def_ast_rate",     label: "Opp AST Rate", fmt: v => v?.toFixed(1), heat: "low",  sectionStart: true, section: "Opp Ball Control",   rank: "rank_def_ast_rate" },
  { key: "def_or_pct",       label: "Opp OR%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_or_pct" },
  { key: "def_dr_pct",       label: "Opp DR%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_dr_pct" },
  { key: "def_off_to_pct",   label: "Opp TO%",     fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_def_off_to_pct" },
  { key: "def_stl_pct",      label: "Opp STL%",    fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_stl_pct" },
  { key: "def_blk_pct",      label: "Opp BLK%",    fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_blk_pct", sectionEnd: true },
  /* Opp Scoring Breakdown */
  { key: "def_to_pts_pct",   label: "Opp TO Pts %", fmt: v => v?.toFixed(1), heat: "low",  sectionStart: true, section: "Opp Scoring Breakdown", rank: "rank_def_to_pts_pct" },
  { key: "def_fb_pts_pct",   label: "Opp FSTBRK %", fmt: v => v?.toFixed(1), heat: "low",  rank: "rank_def_fb_pts_pct" },
  { key: "def_pip_pct",      label: "Opp Paint %",  fmt: v => v?.toFixed(1), heat: "low",  rank: "rank_def_pip_pct", sectionEnd: true },
  /* Adj DE */
  { key: "DefEff_srs",       label: "Adj DE",      fmt: v => v?.toFixed(2),  cls: v => v < 100 ? "eff-good" : v > 100 ? "eff-bad" : "", heat: "low", rank: "rank_def" },
];

/* Tab 7: Bubble Watch */
const BUBBLE_COLS = [
  { key: "rank_slct",        label: "#",            fmt: v => v,               align: "center" },
  { key: "team_displayName", label: "Team",         fmt: v => v,               align: "left" },
  { key: "_status",          label: "Status",       fmt: v => v ?? "",         align: "center" },
  { key: "conference",       label: "Conf",         fmt: v => v ?? "‚Äì",        align: "left" },
  { key: "record",           label: "Record",       fmt: v => v ?? "‚Äì",        align: "center" },
  { key: "streak",           label: "Streak",       fmt: v => v ?? "‚Äì",        align: "center", sortKey: "streak_num", cls: v => v?.[0] === "W" ? "net-pos" : v?.[0] === "L" ? "net-neg" : "" },
  { key: "net_srs",          label: "Total AdjE",   fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "" },
  { key: "sos",              label: "SOS",           fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", rank: "rank_sos" },
  { key: "nc_sos",           label: "NC SOS",        fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", rank: "rank_nc_sos" },
  { key: "season_wab",       label: "WAB",           fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", rank: "rank_wab" },
  { key: "q1a_record",       label: "Q1A",           fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q1a_w" },
  { key: "q1_record",        label: "Q1",            fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q1_w" },
  { key: "q2_record",        label: "Q2",            fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q2_w" },
  { key: "q12_record",       label: "Q1+Q2",         fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q12_w" },
  { key: "q3_record",        label: "Q3",            fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q3_w" },
  { key: "q4_record",        label: "Q4",            fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q4_w" },
  { key: "slct",             label: "SLCT",           fmt: v => v?.toFixed(2), heat: "high" },
  { key: "seed",             label: "SEED",           fmt: v => v?.toFixed(2), heat: "high" },
];

let DATA = [];
let SIM_DATA = [];
let activeTab = "rank";   // "rank", "quad", "advOff", "advDef", "brack", "bubble", "seedOdds"
let sortCol = "net_srs";
let sortAsc = false;
let seedOddsSortCol = "make_pct";
let seedOddsSortAsc = false;

/* ---- restore saved sort/tab state ---- */
(function restoreState() {
  try {
    const s = JSON.parse(localStorage.getItem("cbb_index_state"));
    if (s) {
      activeTab = s.activeTab || activeTab;
      sortCol = s.sortCol || sortCol;
      sortAsc = s.sortAsc ?? sortAsc;
      seedOddsSortCol = s.seedOddsSortCol || seedOddsSortCol;
      seedOddsSortAsc = s.seedOddsSortAsc ?? seedOddsSortAsc;
    }
  } catch(e) {}
})();
function saveState() {
  localStorage.setItem("cbb_index_state", JSON.stringify({
    activeTab, sortCol, sortAsc, seedOddsSortCol, seedOddsSortAsc
  }));
}

function getCols() {
  if (activeTab === "quad") return QUAD_COLS;
  if (activeTab === "advOff") return ADV_OFF_COLS;
  if (activeTab === "advDef") return ADV_DEF_COLS;
  if (activeTab === "bubble") return BUBBLE_COLS;
  return RANK_COLS;
}

/* ---- fetch data ---- */
fetch("data.json")
  .then(r => r.json())
  .then(d => {
    DATA = d;
    /* apply restored tab/sort state */
    const saved = activeTab;
    activeTab = "__force__";          // force switchTab to run even if same
    switchTab(saved, sortCol, sortAsc);
  })
  .catch(e => { document.getElementById("tbody").innerHTML = `<tr><td colspan="8">Failed to load data: ${e}</td></tr>`; });

fetch("sim_results.json")
  .then(r => r.json())
  .then(d => { SIM_DATA = d; })
  .catch(() => { SIM_DATA = []; });

let GAMES_DATA = {};
fetch("games.json")
  .then(r => r.json())
  .then(d => { GAMES_DATA = d; })
  .catch(() => { GAMES_DATA = {}; });

/* ---- heatmap helper ---- */
function heatColor(val, min, max, invert) {
  if (val == null || min === max) return "";
  let t = (val - min) / (max - min);
  if (invert) t = 1 - t;
  // dark blue (13,27,42) ‚Üí light blue (88,166,255)
  const r = Math.round(13 + (88 - 13) * t);
  const g = Math.round(27 + (166 - 27) * t);
  const b = Math.round(42 + (255 - 42) * t);
  return `rgba(${r},${g},${b},0.25)`;
}

/* ---- build header ---- */
function buildHeader() {
  const thead = document.getElementById("headerRow").parentElement;
  thead.innerHTML = "";
  const COLS = getCols();
  const hasSections = COLS.some(c => c.section);

  // Section header row for tabs with grouped sections
  if (hasSections) {
    const sectionRow = document.createElement("tr");
    // Count non-section leading cols
    let leadCols = 0;
    for (const c of COLS) { if (!c.section) leadCols++; else break; }
    // Blank header for leading cols
    if (leadCols > 0) {
      const blankTh = document.createElement("th");
      blankTh.setAttribute("colspan", leadCols);
      blankTh.style.borderBottom = "none";
      sectionRow.appendChild(blankTh);
    }
    // Gather sections from remaining cols
    let curSection = null, curSpan = 0, sections = [], sectionClosed = false;
    COLS.slice(leadCols).forEach(c => {
      if (c.section && c.section !== curSection) {
        // New named section ‚Äî push previous if any
        if (curSection !== null) sections.push({ label: curSection, span: curSpan });
        else if (sectionClosed && curSpan > 0) sections.push({ label: "", span: curSpan });
        curSection = c.section;
        curSpan = 0;
        sectionClosed = false;
      }
      curSpan++;
      if (c.sectionEnd) {
        sections.push({ label: curSection, span: curSpan });
        curSection = null;
        curSpan = 0;
        sectionClosed = true;
      }
    });
    // Flush any remaining cols
    if (curSection !== null) sections.push({ label: curSection, span: curSpan });
    else if (curSpan > 0) sections.push({ label: "", span: curSpan });
    sections.forEach(s => {
      const th = document.createElement("th");
      th.setAttribute("colspan", s.span);
      if (s.label) {
        th.style.background = "rgba(88,166,255,.06)";
        th.style.color = "var(--text-dim)";
        th.style.fontSize = ".7rem";
        th.style.fontWeight = "700";
        th.style.textTransform = "uppercase";
        th.style.letterSpacing = ".05em";
        th.style.borderBottom = "2px solid var(--accent)";
        th.style.padding = "3px 7px";
        th.textContent = s.label;
      } else {
        th.style.borderBottom = "none";
      }
      sectionRow.appendChild(th);
    });
    thead.appendChild(sectionRow);
  }

  const tr = document.createElement("tr");
  tr.id = "headerRow";
  COLS.forEach(c => {
    const th = document.createElement("th");
    th.textContent = c.label;
    th.style.textAlign = c.align || "center";
    if (c.sectionStart) th.classList.add("section-start");
    if (c.sectionEnd) th.classList.add("section-end");
    if (c.width) th.style.width = c.width;
    th.addEventListener("click", () => {
      if (sortCol === c.key) sortAsc = !sortAsc;
      else { sortCol = c.key; sortAsc = c.key === "team_displayName"; }
      saveState();
      render();
    });
    tr.appendChild(th);
  });
  thead.appendChild(tr);
}

/* ---- render table ---- */
function render() {
  const COLS = getCols();
  const q = document.getElementById("search").value.toLowerCase();
  let rows = DATA;

  /* bubble tab: filter to SLCT rank 37-58 and add status labels */
  if (activeTab === "bubble") {
    rows = rows.filter(r => r.rank_slct >= 37 && r.rank_slct <= 58);
    rows = rows.map(r => {
      const s = { ...r };
      if (r.bracket === "at-large") s._status = "‚úÖ In - " + (r.proj_seed ?? "?");
      else if (r.bracket === "auto") s._status = "üèÜ AQ";
      else if (r.bracket === "first_four_out") s._status = "‚ö†Ô∏è F4O";
      else if (r.bracket === "next_four_out") s._status = "‚ùå N4O";
      else s._status = "‚ùå Out";
      return s;
    });
  }

  if (q) rows = rows.filter(r => r.team_displayName?.toLowerCase().includes(q) || r.team_abbr?.toLowerCase().includes(q));

  rows = [...rows].sort((a, b) => {
    const colDef = COLS.find(c => c.key === sortCol);
    const sk = colDef?.sortKey || (sortCol === "_rank" ? colDef?.rankKey : null) || sortCol;
    let va = a[sk], vb = b[sk];
    if (va == null) return 1; if (vb == null) return -1;
    if (typeof va === "string") { va = va.toLowerCase(); vb = (vb || "").toLowerCase(); }
    return sortAsc ? (va > vb ? 1 : va < vb ? -1 : 0) : (va < vb ? 1 : va > vb ? -1 : 0);
  });

  // compute heatmap min/max for each column that has a heat property
  const bounds = {};
  COLS.forEach(c => {
    if (!c.heat) return;
    const vals = rows.map(r => r[c.key]).filter(v => v != null);
    if (vals.length) { bounds[c.key] = { min: Math.min(...vals), max: Math.max(...vals) }; }
  });

  const tbody = document.getElementById("tbody");
  const frags = [];
  rows.forEach((r, i) => {
    const cells = COLS.map(c => {
      const v = c.key === "_rank" ? r[c.rankKey || "rank_net"] : r[c.key];
      let display = v != null ? c.fmt(v) : "‚Äì";
      if (c.key === "team_displayName" && r.team_abbr) {
        const mIcon = r.momentum_l5 >= 90 ? " üî•" : r.momentum_l5 <= 10 ? " ‚ùÑÔ∏è" : "";
        display = `<a href="team.html?team=${encodeURIComponent(r.team_abbr)}" style="color:var(--accent);text-decoration:none">${display}</a>${mIcon}`;
      }
      if (c.key === "conference" && v) {
        display = `<a href="conference.html?conf=${encodeURIComponent(v)}" style="color:var(--accent);text-decoration:none">${display}</a>`;
      }
      if (c.rank && r[c.rank] != null) {
        display += `<span class="rk">${r[c.rank]}</span>`;
      }
      let cls = (c.cls ? c.cls(v) : "");
      if (c.key === "_status" && v) {
        if (v.includes("In")) cls += " bubble-in";
        else if (v.includes("AQ")) cls += " bubble-aq";
        else if (v.includes("F4O")) cls += " bubble-f4o";
        else cls += " bubble-out";
      }
      const align = c.align || "center";
      let style = `text-align:${align}`;
      if (c.heat && v != null && bounds[c.key]) {
        const bg = heatColor(v, bounds[c.key].min, bounds[c.key].max, c.heat === "low");
        if (bg) style += `;background:${bg}`;
      }
      return `<td style="${style}" class="${cls} ${c.heat ? 'heatmap' : ''} ${c.sectionStart ? 'section-start' : ''} ${c.sectionEnd ? 'section-end' : ''}">${display}</td>`;
    }).join("");
    frags.push(`<tr>${cells}</tr>`);
  });
  tbody.innerHTML = frags.join("");
  document.getElementById("rowCount").textContent = `${rows.length} teams`;

  // update header arrows
  document.querySelectorAll("#headerRow th").forEach((th, i) => {
    const col = COLS[i];
    const arrow = col.key === sortCol ? (sortAsc ? " ‚ñ≤" : " ‚ñº") : "";
    th.textContent = col.label + arrow;
  });
}

/* ---- seed odds table ---- */
const SEED_ODDS_COLS = [
  { key: "current_slct_rank", label: "#",        sortable: true },
  { key: "team_displayName",  label: "Team",     sortable: true, align: "left" },
  { key: "conference",        label: "Conf",     sortable: true, align: "left" },
  { key: "remaining_games",   label: "Rem",      sortable: true },
  { key: "make_pct",          label: "Make%",    sortable: true, fmt: v => v.toFixed(1) + "%", heat: true },
  { key: "avg_seed_if_make",  label: "Avg",      sortable: true, fmt: v => v != null ? v.toFixed(1) : "‚Äì" },
  { key: "most_likely_seed",  label: "MLS",      sortable: true, fmt: v => v ?? "‚Äì" },
  { key: "seed_1_pct",  label: "1",  sortable: true, seed: true },
  { key: "seed_2_pct",  label: "2",  sortable: true, seed: true },
  { key: "seed_3_pct",  label: "3",  sortable: true, seed: true },
  { key: "seed_4_pct",  label: "4",  sortable: true, seed: true },
  { key: "seed_5_pct",  label: "5",  sortable: true, seed: true },
  { key: "seed_6_pct",  label: "6",  sortable: true, seed: true },
  { key: "seed_7_pct",  label: "7",  sortable: true, seed: true },
  { key: "seed_8_pct",  label: "8",  sortable: true, seed: true },
  { key: "seed_9_pct",  label: "9",  sortable: true, seed: true },
  { key: "seed_10_pct", label: "10", sortable: true, seed: true },
  { key: "seed_11_plus", label: "11+", sortable: true, seed: true },
  { key: "out_pct",     label: "Out", sortable: true, seed: true },
];

function seedHeat(v) {
  if (v == null || v === 0) return "";
  /* green intensity scaled by probability: 0 ‚Üí transparent, 100 ‚Üí full green */
  const t = Math.min(v / 100, 1);
  const alpha = 0.08 + t * 0.55;
  return `rgba(63,185,80,${alpha.toFixed(2)})`;
}

function outHeat(v) {
  if (v == null || v === 0) return "";
  const t = Math.min(v / 100, 1);
  const alpha = 0.08 + t * 0.55;
  return `rgba(248,81,73,${alpha.toFixed(2)})`;
}

function renderSeedOdds() {
  if (!SIM_DATA.length) return;

  /* pre-compute 11+ column */
  const rows = SIM_DATA.map(r => ({
    ...r,
    seed_11_plus: (r.seed_11_pct || 0) + (r.seed_12_pct || 0) + (r.seed_13_pct || 0) + (r.seed_14_pct || 0) + (r.seed_15_pct || 0) + (r.seed_16_pct || 0),
  }));

  /* filter by search */
  const q = document.getElementById("seedOddsSearch").value.toLowerCase();
  let filtered = rows;
  if (q) filtered = filtered.filter(r => r.team_displayName?.toLowerCase().includes(q) || r.team_abbr?.toLowerCase().includes(q));

  /* sort */
  filtered = [...filtered].sort((a, b) => {
    let va = a[seedOddsSortCol], vb = b[seedOddsSortCol];
    if (va == null) return 1; if (vb == null) return -1;
    if (typeof va === "string") { va = va.toLowerCase(); vb = (vb || "").toLowerCase(); }
    return seedOddsSortAsc ? (va > vb ? 1 : va < vb ? -1 : 0) : (va < vb ? 1 : va > vb ? -1 : 0);
  });

  /* filter out teams with negligible make% unless searching */
  if (!q) filtered = filtered.filter(r => r.make_pct >= 0.5);

  /* build header */
  const thead = document.getElementById("seedOddsHeader");
  thead.innerHTML = "";
  SEED_ODDS_COLS.forEach(c => {
    const th = document.createElement("th");
    const arrow = c.key === seedOddsSortCol ? (seedOddsSortAsc ? " ‚ñ≤" : " ‚ñº") : "";
    th.textContent = c.label + arrow;
    if (c.align) th.style.textAlign = c.align;
    th.addEventListener("click", () => {
      if (seedOddsSortCol === c.key) seedOddsSortAsc = !seedOddsSortAsc;
      else { seedOddsSortCol = c.key; seedOddsSortAsc = c.key === "team_displayName"; }
      saveState();
      renderSeedOdds();
    });
    thead.appendChild(th);
  });

  /* build rows */
  const tbody = document.getElementById("seedOddsTbody");
  const frags = [];
  filtered.forEach(r => {
    const cells = SEED_ODDS_COLS.map(c => {
      const v = r[c.key];
      let display, style = "", cls = "";

      if (c.key === "team_displayName") {
        display = `<a href="team.html?team=${encodeURIComponent(r.team_abbr)}">${v}</a>`;
        cls = "team-cell";
      } else if (c.key === "conference") {
        display = v ? `<a href="conference.html?conf=${encodeURIComponent(v)}">${v}</a>` : "‚Äì";
        cls = "conf-cell";
      } else if (c.seed) {
        display = v != null && v > 0 ? v.toFixed(1) : "";
        const bg = c.key === "out_pct" ? outHeat(v) : seedHeat(v);
        if (bg) style = `background:${bg}`;
      } else if (c.heat) {
        display = c.fmt ? c.fmt(v) : v;
        const bg = seedHeat(v);
        if (bg) style = `background:${bg}`;
      } else {
        display = c.fmt ? c.fmt(v) : (v ?? "‚Äì");
      }

      const align = c.align || "center";
      return `<td class="${cls}" style="text-align:${align};${style}">${display}</td>`;
    }).join("");
    frags.push(`<tr>${cells}</tr>`);
  });
  tbody.innerHTML = frags.join("");
  document.getElementById("seedOddsCount").textContent = `${filtered.length} teams`;
}

/* ---- bracket grid view ---- */
function renderBracket() {
  const teams = DATA.filter(r => r.bracket === "auto" || r.bracket === "at-large")
    .sort((a, b) => (a.rank_seed || 999) - (b.rank_seed || 999));

  /* Each column defines its header and seed-line groups with explicit sizes.
     Seeds 1-10: 4 teams each, 11: 6, 12: 4, 13-15: 4 each, 16: 6  = 68 */
  const columns = [
    { label: "1 ‚Äì 4 Seeds",   groups: [ {seed:1,n:4},{seed:2,n:4},{seed:3,n:4},{seed:4,n:4} ] },
    { label: "5 ‚Äì 8 Seeds",   groups: [ {seed:5,n:4},{seed:6,n:4},{seed:7,n:4},{seed:8,n:4} ] },
    { label: "9 ‚Äì 12 Seeds",  groups: [ {seed:9,n:4},{seed:10,n:4},{seed:11,n:6},{seed:12,n:4} ] },
    { label: "13 ‚Äì 16 Seeds", groups: [ {seed:13,n:4},{seed:14,n:4},{seed:15,n:4},{seed:16,n:6} ] },
  ];

  /* Identify last 4 at-large teams (lowest SLCT among at-large) */
  const atLargeTeams = teams.filter(t => t.bracket === "at-large")
    .sort((a, b) => (a.slct || 0) - (b.slct || 0));
  const lastFourAbbrs = new Set(atLargeTeams.slice(0, 4).map(t => t.team_abbr));

  function teamRow(t, idx) {
    const rank = idx + 1;
    const bidCls = t.bracket === "auto" ? "auto" : "at-large";
    const bidLabel = t.bracket === "auto" ? "AQ" : "AL";
    const isL4 = lastFourAbbrs.has(t.team_abbr);
    const l4Badge = isL4 ? ' <span class="l4-badge">L4</span>' : '';
    const link = `<a href="team.html?team=${encodeURIComponent(t.team_abbr)}">${t.team_displayName}</a>`;
    return `<div class="bracket-row">
      <span class="bracket-seed">${rank}</span>
      <span class="bracket-team">${link}${l4Badge}</span>
      <span class="bracket-bid ${bidCls}">${bidLabel}</span>
      <span class="bracket-stat">${t.slct?.toFixed(2) ?? "‚Äì"}</span>
      <span class="bracket-stat">${t.seed?.toFixed(2) ?? "‚Äì"}</span>
    </div>`;
  }

  const grid = document.getElementById("bracketGrid");
  let pos = 0;   // running position across all 68 teams
  grid.innerHTML = columns.map(col => {
    const groupsHtml = col.groups.map(g => {
      const block = teams.slice(pos, pos + g.n);
      const rows = block.map((t, j) => teamRow(t, pos + j)).join("");
      pos += g.n;
      return `<div class="seed-group">
        <div class="seed-group-label">${g.seed} seed</div>
        <div class="seed-group-teams">${rows}</div>
      </div>`;
    }).join("");
    return `<div class="bracket-col">
      <div class="bracket-col-header">
        <span>${col.label}</span>
        <span><span>SLCT</span><span>SEED</span></span>
      </div>
      ${groupsHtml}
    </div>`;
  }).join("");

  // ---- bubble: first 4 out & next 4 out ----
  const first4 = DATA.filter(r => r.bracket === "first_four_out")
    .sort((a, b) => (b.slct || 0) - (a.slct || 0));
  const next4 = DATA.filter(r => r.bracket === "next_four_out")
    .sort((a, b) => (b.slct || 0) - (a.slct || 0));

  function bubbleRow(t) {
    const link = `<a href="team.html?team=${encodeURIComponent(t.team_abbr)}">${t.team_displayName}</a>`;
    return `<div class="bracket-row">
      <span class="bracket-team">${link}</span>
      <span class="bracket-stat">${t.slct?.toFixed(2) ?? "‚Äì"}</span>
      <span class="bracket-stat">${t.seed?.toFixed(2) ?? "‚Äì"}</span>
    </div>`;
  }

  document.getElementById("bubbleSection").innerHTML = [
    { teams: first4, label: "First Four Out", cls: "first-out" },
    { teams: next4,  label: "Next Four Out",  cls: "next-out" },
  ].map(b => `<div class="bubble-box">
    <div class="bubble-header ${b.cls}">
      <span>${b.label}</span>
      <span><span>SLCT</span><span>SEED</span></span>
    </div>
    ${b.teams.map(t => bubbleRow(t)).join("")}
  </div>`).join("");
}

/* ---- tab switching ---- */
function switchTab(tab, col, asc) {
  if (activeTab === tab) return;
  activeTab = tab;
  sortCol = col; sortAsc = asc;
  saveState();
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById("tab" + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add("active");

  const tableWrap = document.querySelector(".table-wrap");
  const bracketWrap = document.getElementById("bracketWrap");
  const seedOddsWrap = document.getElementById("seedOddsWrap");
  const compareWrap = document.getElementById("compareWrap");
  const controls = document.querySelector(".controls");
  if (tab === "brack") {
    tableWrap.style.display = "none";
    controls.style.display = "none";
    bracketWrap.style.display = "block";
    seedOddsWrap.style.display = "none";
    compareWrap.style.display = "none";
    renderBracket();
  } else if (tab === "seedOdds") {
    tableWrap.style.display = "none";
    controls.style.display = "none";
    bracketWrap.style.display = "none";
    seedOddsWrap.style.display = "block";
    compareWrap.style.display = "none";
    renderSeedOdds();
  } else if (tab === "compare") {
    tableWrap.style.display = "none";
    controls.style.display = "none";
    bracketWrap.style.display = "none";
    seedOddsWrap.style.display = "none";
    compareWrap.style.display = "block";
    renderCompareTags();
    renderCompareTable();
  } else {
    tableWrap.style.display = "";
    controls.style.display = "";
    bracketWrap.style.display = "none";
    seedOddsWrap.style.display = "none";
    compareWrap.style.display = "none";
    document.getElementById("mainTable").classList.toggle("adv-mode", tab === "advOff" || tab === "advDef");
    buildHeader(); render();
  }
}
document.getElementById("tabRank").addEventListener("click", () => switchTab("rank", "net_srs", false));
document.getElementById("tabQuad").addEventListener("click", () => switchTab("quad", "season_wab", false));
document.getElementById("tabAdvOff").addEventListener("click", () => switchTab("advOff", "OffEff_srs", false));
document.getElementById("tabAdvDef").addEventListener("click", () => switchTab("advDef", "DefEff_srs", true));
document.getElementById("tabBrack").addEventListener("click", () => switchTab("brack", "rank_seed", true));
document.getElementById("tabBubble").addEventListener("click", () => switchTab("bubble", "rank_slct", true));
document.getElementById("tabSeedOdds").addEventListener("click", () => switchTab("seedOdds", "make_pct", false));
document.getElementById("tabCompare").addEventListener("click", () => switchTab("compare", null, false));

/* ---- comparison tool ---- */

/* helper: get best N wins or worst N losses for a team, by WAB */
function getTopGames(abbr, type, n = 3) {
  const games = GAMES_DATA[abbr];
  if (!games || games.length === 0) return [];
  if (type === "wins") {
    return games.filter(g => g._won)
      .sort((a, b) => b.wab - a.wab)
      .slice(0, n);
  } else {
    return games.filter(g => !g._won)
      .sort((a, b) => a.wab - b.wab)
      .slice(0, n);
  }
}

/* format a list of games as HTML lines: "#4 Purdue (+0.91)" */
function formatGameList(games, type) {
  if (!games || games.length === 0) return `<span class="game-list-none">None</span>`;
  return games.map(g => {
    const rank = g.opp_seed_rank;
    /* strip mascot: keep everything except the last word(s) */
    const full = g.opp_team_displayName || g.opp_team_abbr;
    const parts = full.split(" ");
    /* heuristic: if >1 word, drop last word (mascot). Handle 2-word mascots like "Blue Devils" */
    const twoWordMascots = ["Blue Devils","Tar Heels","Red Raiders","Horned Frogs","Sun Devils",
      "Yellow Jackets","Demon Deacons","War Eagles","Nittany Lions","Scarlet Knights",
      "Fighting Irish","Mean Green","Boston Terriers","Golden Eagles","Flying Dutchmen",
      "Great Danes","Runnin Bulldogs","Crimson Tide"];
    let name = full;
    for (const m of twoWordMascots) {
      if (full.endsWith(m)) { name = full.slice(0, -m.length).trim(); break; }
    }
    if (name === full && parts.length > 1) name = parts.slice(0, -1).join(" ");
    if (!name) name = g.opp_team_abbr;
    const wab = g.wab >= 0 ? "+" + g.wab.toFixed(2) : g.wab.toFixed(2);
    const cls = type === "wins" ? "net-pos" : "net-neg";
    const loc = g.homeAway === "away" ? "at" : g.homeAway === "neutral" ? "vs" : "vs";
    return `<div class="game-list-item"><span class="game-list-rank">${loc} #${rank}</span> <a href="team.html?team=${encodeURIComponent(g.opp_team_abbr)}" class="game-list-link">${name}</a> <span class="${cls}">(${wab})</span></div>`;
  }).join("");
}

const COMPARE_COLS = [
  { key: "team_displayName", label: "Team",         align: "left",   link: true },
  { key: "conference",       label: "Conf",         align: "left" },
  { key: "record",           label: "Record",       align: "center" },
  { key: "streak",           label: "Streak",       align: "center", cls: v => v?.[0] === "W" ? "net-pos" : v?.[0] === "L" ? "net-neg" : "" },
  { key: "net_srs",          label: "Total AdjE",   align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", best: "high" },
  { key: "sos",              label: "SOS",           align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", best: "high" },
  { key: "nc_sos",           label: "NC SOS",        align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", best: "high" },
  { key: "season_wab",       label: "WAB",           align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", best: "high" },
  { key: "q1a_record",       label: "Q1A",           align: "center", sortKey: "q1a_w", best: "high_w" },
  { key: "q1_record",        label: "Q1",            align: "center", sortKey: "q1_w",  best: "high_w" },
  { key: "q2_record",        label: "Q2",            align: "center", sortKey: "q2_w",  best: "high_w" },
  { key: "q12_record",       label: "Q1+Q2",         align: "center", sortKey: "q12_w", best: "high_w" },
  { key: "q3_record",        label: "Q3",            align: "center", sortKey: "q3_w" },
  { key: "q4_record",        label: "Q4",            align: "center", sortKey: "q4_w" },
  { key: "slct",             label: "SLCT",           align: "center", fmt: v => v?.toFixed(2), best: "high" },
  { key: "seed",             label: "SEED",           align: "center", fmt: v => v?.toFixed(2), best: "high" },
  { key: "_best3wins",       label: "Best 3 Wins",    align: "left",  custom: true },
  { key: "_worst3losses",    label: "Worst 3 Losses", align: "left",  custom: true },
];

let compareTeams = [];  // array of team_abbr strings

function renderCompareTags() {
  const tagsEl = document.getElementById("compareTags");
  if (compareTeams.length === 0) {
    tagsEl.innerHTML = "";
    return;
  }
  const lookup = {};
  DATA.forEach(t => { lookup[t.team_abbr] = t; });
  let html = compareTeams.map(abbr => {
    const t = lookup[abbr];
    const name = t ? t.team_displayName : abbr;
    return `<span class="compare-tag">${name}<span class="remove-tag" data-abbr="${abbr}">&times;</span></span>`;
  }).join("");
  html += `<button class="compare-clear" id="compareClearAll">Clear all</button>`;
  tagsEl.innerHTML = html;

  tagsEl.querySelectorAll(".remove-tag").forEach(btn => {
    btn.addEventListener("click", () => {
      compareTeams = compareTeams.filter(a => a !== btn.dataset.abbr);
      renderCompareTags();
      renderCompareTable();
    });
  });
  document.getElementById("compareClearAll").addEventListener("click", () => {
    compareTeams = [];
    renderCompareTags();
    renderCompareTable();
  });
}

function renderCompareTable() {
  const emptyEl = document.getElementById("compareEmpty");
  const tableEl = document.getElementById("compareTable");

  if (compareTeams.length === 0) {
    emptyEl.style.display = "";
    tableEl.style.display = "none";
    return;
  }
  emptyEl.style.display = "none";
  tableEl.style.display = "";

  const lookup = {};
  DATA.forEach(t => { lookup[t.team_abbr] = t; });
  const teams = compareTeams.map(a => lookup[a]).filter(Boolean);

  /* find best value for each column (for highlighting) */
  const bestVals = {};
  COMPARE_COLS.forEach(c => {
    if (!c.best) return;
    const sk = c.sortKey || c.key;
    const vals = teams.map(t => t[sk]).filter(v => v != null);
    if (vals.length === 0) return;
    if (c.best === "high" || c.best === "high_w") bestVals[c.key] = Math.max(...vals);
    else bestVals[c.key] = Math.min(...vals);
  });

  /* header */
  const thead = document.getElementById("compareHeader");
  thead.innerHTML = COMPARE_COLS.map(c =>
    `<th style="text-align:${c.align || 'center'}">${c.label}</th>`
  ).join("");

  /* rows */
  const tbody = document.getElementById("compareTbody");
  const frags = [];
  teams.forEach(t => {
    const cells = COMPARE_COLS.map(c => {
      let display, cls = "", tdCls = "";
      let style = `text-align:${c.align || 'center'}`;

      /* custom columns: best wins / worst losses */
      if (c.custom) {
        if (c.key === "_best3wins") {
          display = formatGameList(getTopGames(t.team_abbr, "wins", 3), "wins");
        } else if (c.key === "_worst3losses") {
          display = formatGameList(getTopGames(t.team_abbr, "losses", 3), "losses");
        } else {
          display = "‚Äì";
        }
        tdCls = "game-list-cell";
        return `<td class="${tdCls}" style="${style}">${display}</td>`;
      }

      const v = t[c.key];
      display = c.fmt ? c.fmt(v) : (v ?? "‚Äì");
      cls = c.cls ? c.cls(v) : "";

      if (c.link && t.team_abbr) {
        display = `<a href="team.html?team=${encodeURIComponent(t.team_abbr)}">${display}</a>`;
        tdCls = "team-cell";
      }

      /* highlight best value */
      if (c.best && bestVals[c.key] != null && teams.length > 1) {
        const sk = c.sortKey || c.key;
        if (t[sk] != null && t[sk] === bestVals[c.key]) {
          cls += " best-val";
        }
      }

      return `<td class="${tdCls} ${cls}" style="${style}">${display}</td>`;
    }).join("");
    frags.push(`<tr>${cells}</tr>`);
  });
  tbody.innerHTML = frags.join("");
}

/* autocomplete */
const compareInput = document.getElementById("compareSearch");
const compareAC = document.getElementById("compareAutocomplete");

compareInput.addEventListener("input", () => {
  const q = compareInput.value.toLowerCase().trim();
  if (!q) { compareAC.style.display = "none"; return; }

  const matches = DATA.filter(t =>
    !compareTeams.includes(t.team_abbr) &&
    (t.team_displayName?.toLowerCase().includes(q) || t.team_abbr?.toLowerCase().includes(q))
  ).slice(0, 10);

  if (matches.length === 0) { compareAC.style.display = "none"; return; }
  compareAC.style.display = "block";
  compareAC.innerHTML = matches.map(t =>
    `<div data-abbr="${t.team_abbr}">
      <span>${t.team_displayName}</span>
      <span class="ac-conf">${t.conference || ""}</span>
    </div>`
  ).join("");

  compareAC.querySelectorAll("div").forEach(el => {
    el.addEventListener("click", () => {
      compareTeams.push(el.dataset.abbr);
      compareInput.value = "";
      compareAC.style.display = "none";
      renderCompareTags();
      renderCompareTable();
    });
  });
});

compareInput.addEventListener("keydown", (e) => {
  if (e.key === "Escape") { compareAC.style.display = "none"; }
});

document.addEventListener("click", (e) => {
  if (!e.target.closest(".compare-controls")) {
    compareAC.style.display = "none";
  }
});

/* ---- search listeners ---- */
document.getElementById("search").addEventListener("input", render);
document.getElementById("seedOddsSearch").addEventListener("input", renderSeedOdds);
</script>
</body>
</html>
