<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-020D2NVH9F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-020D2NVH9F');
</script>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">
<meta property="og:title" content="AIB College Basketball Ratings 2025-26">
<meta property="og:description" content="College basketball rankings, bracketology, and analytics powered by AI Bracketology">
<meta property="og:image" content="https://ai-bracketology.github.io/cbb-rankings/docs/new_header.png">
<meta property="og:url" content="https://ai-bracketology.github.io/cbb-rankings/docs/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<script>
  // Apply saved theme immediately to prevent flash
  (function(){
    var t = localStorage.getItem("cbb_theme");
    if (t === "light") document.documentElement.setAttribute("data-theme","light");
  })();
  /* reload when restored from bfcache (back/forward navigation) */
  window.addEventListener("pageshow", function(e) {
    if (e.persisted) window.location.reload();
  });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIB College Basketball Ratings 2025-26</title>
<style>
  :root {
  /* bubble teams (first/next 4 out) */
  .bubble-section {
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 20px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  @media (max-width: 600px) {
    .bubble-section {
      grid-template-columns: 1fr;
    }
  }
    --bg:        #0d1117;
    --surface:   #161b22;
    --border:    #30363d;
    --text:      #c9d1d9;
    --text-dim:  #8b949e;
    --accent:    #58a6ff;
    --green:     #3fb950;
    --red:       #f85149;
    --gold:      #d29922;
  }
  html[data-theme="light"] {
    --bg:        #ffffff;
    --surface:   #f6f8fa;
    --border:    #d0d7de;
    --text:      #1f2328;
    --text-dim:  #656d76;
    --accent:    #0969da;
    --green:     #1a7f37;
    --red:       #cf222e;
    --gold:      #9a6700;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
  }

  /* ---------- header ---------- */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 24px 32px;
    text-align: center;
  }
  header h1 { font-size: 1.6rem; font-weight: 600; }
  header p  { color: var(--text-dim); font-size: .85rem; margin-top: 4px; }
  .header-actions { margin-top: 10px; }
  .header-actions a {
    display: inline-block;
    background: var(--accent);
    color: #fff;
    font-weight: 600;
    font-size: .82rem;
    padding: 6px 16px;
    border-radius: 6px;
    text-decoration: none;
    transition: opacity .15s;
  }
  .header-actions a:hover { opacity: .85; }

  /* ---------- theme toggle ---------- */
  .theme-toggle {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 1.1rem;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: border-color .15s;
    line-height: 1;
    vertical-align: middle;
    margin-left: 6px;
  }
  .theme-toggle:hover { border-color: var(--accent); }

  /* ---------- controls ---------- */
  .controls {
    max-width: 1400px;
    margin: 20px auto 0;
    padding: 0 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  .controls input[type="text"] {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 12px;
    font-size: .9rem;
    width: 280px;
    outline: none;
  }
  .controls input[type="text"]:focus { border-color: var(--accent); }
  .controls .stat-count {
    color: var(--text-dim);
    font-size: .82rem;
    margin-left: auto;
  }

  /* ---------- table wrapper ---------- */
  .table-wrap {
    max-width: 1400px;
    margin: 16px auto 40px;
    padding: 0 20px;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: .82rem;
  }
  thead { position: sticky; top: 0; z-index: 2; }
  thead th {
    background: var(--surface);
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    padding: 10px 8px;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    text-align: center;
  }
  thead th:hover { color: var(--accent); }
  thead th .arrow { font-size: .65rem; margin-left: 3px; }

  tbody tr { border-bottom: 1px solid var(--border); }
  tbody tr:hover { background: rgba(88,166,255,.06); }
  tbody td {
    padding: 8px 8px;
    white-space: nowrap;
    text-align: center;
  }
  tbody td:first-child { color: var(--text-dim); }
  tbody td:nth-child(2) { font-weight: 500; }

  /* colour-coded efficiency cells */
  .eff-good { color: var(--green); }
  .eff-bad  { color: var(--red); }
  .net-pos  { color: var(--green); font-weight: 600; }
  .net-neg  { color: var(--red); }

  /* heatmap cell */
  .heatmap  { border-radius: 4px; }

  /* quadrant record tooltip */
  .quad-tip-cell {
    position: relative;
    cursor: default;
  }
  .quad-tip {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    z-index: 50;
    white-space: nowrap;
    box-shadow: 0 4px 16px rgba(0,0,0,.3);
    font-size: .78rem;
    line-height: 1.7;
    min-width: 160px;
    pointer-events: none;
  }
  .quad-tip-cell:hover .quad-tip { display: block; }
  /* flip tooltip below the cell for top rows so it isn't clipped */
  .quad-tip-below .quad-tip {
    bottom: auto;
    top: 100%;
  }
  .quad-tip-game { display: flex; gap: 6px; align-items: center; }
  .quad-tip-game a { color: var(--accent); text-decoration: none; }
  .quad-tip-game a:hover { text-decoration: underline; }
  .quad-tip-win { color: var(--green); font-weight: 600; }
  .quad-tip-loss { color: var(--red); }
  .quad-tip-rank { color: var(--text-dim); font-size: .7rem; min-width: 28px; text-align: right; }
  .quad-tip-loc { color: var(--text-dim); font-size: .72rem; min-width: 16px; }

  /* section divider for grouped columns */
  .section-start {
    border-left: 2px solid var(--accent) !important;
  }
  .section-end {
    border-right: 2px solid var(--accent) !important;
  }

  /* compact advanced-stats mode */
  table.adv-mode { table-layout: fixed; }
  table.adv-mode thead th {
    white-space: normal;
    word-break: break-word;
    font-size: .72rem;
    padding: 8px 4px;
    line-height: 1.25;
  }
  table.adv-mode tbody td {
    font-size: .78rem;
    padding: 6px 4px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* inline rank badge */
  .rk {
    display: inline-block;
    font-size: .65rem;
    color: var(--text-dim);
    margin-left: 4px;
    vertical-align: super;
    opacity: .75;
  }

  /* pill badges for ranks */
  .rank-pill {
    display: inline-block;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1px 7px;
    font-size: .72rem;
    color: var(--text-dim);
    margin-left: 4px;
  }

  /* responsive */
  @media (max-width: 768px) {
    .controls { flex-direction: column; align-items: stretch; }
    .controls input[type="text"] { width: 100%; }
    .controls .stat-count { margin-left: 0; }
    .table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    table.adv-mode {
      min-width: 1100px;
      font-size: 0.72rem;
    }
    table.adv-mode thead th, table.adv-mode tbody td {
      padding: 4px 2px;
      font-size: 0.72rem;
    }
    table.adv-mode thead th {
      white-space: normal;
      word-break: break-word;
    }
    table.adv-mode tbody td {
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }

  /* footer */
  footer {
    text-align: center;
    padding: 24px;
    color: var(--text-dim);
    font-size: .75rem;
    border-top: 1px solid var(--border);
  }
  footer a { color: var(--accent); text-decoration: none; }

  /* ---------- tabs ---------- */
  .tabs {
    max-width: 1400px;
    margin: 20px auto 0;
    padding: 0 20px;
    display: flex;
    gap: 4px;
  }
  .tab-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    color: var(--text-dim);
    padding: 9px 20px;
    font-size: .85rem;
    font-weight: 600;
    cursor: pointer;
    transition: color .15s, border-color .15s;
  }
  .tab-btn:hover { color: var(--text); }
  .tab-btn.active {
    color: var(--accent);
    border-color: var(--accent);
    background: var(--bg);
  }

  /* ---------- bracket grid ---------- */
  .bracket-wrap {
    max-width: 1400px;
    margin: 16px auto 40px;
    padding: 0 20px;
    display: none;          /* shown only on brack tab */
  }
  .bracket-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }
  .bracket-col {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .bracket-col-header {
    background: rgba(88,166,255,.08);
    padding: 8px 12px;
    font-weight: 700;
    font-size: .8rem;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: .04em;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
  }
  .bracket-col-header span:last-child {
    font-size: .7rem;
    color: var(--text-dim);
    letter-spacing: 0;
    text-transform: none;
    display: flex;
    gap: 12px;
  }
  .bracket-row {
    display: flex;
    align-items: center;
    padding: 5px 10px;
    border-bottom: 1px solid var(--border);
    font-size: .82rem;
    gap: 5px;
    transition: background .12s;
  }
  .bracket-row:last-child { border-bottom: none; }
  .bracket-row:hover { background: rgba(88,166,255,.06); }
  .bracket-seed {
    width: 20px;
    font-weight: 700;
    color: var(--text-dim);
    text-align: center;
    flex-shrink: 0;
    font-size: .78rem;
  }
  .bracket-team {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .bracket-team a {
    color: var(--text);
    text-decoration: none;
    font-weight: 500;
  }
  .bracket-team a:hover { color: var(--accent); }
  .bracket-bid {
    font-size: .62rem;
    padding: 1px 4px;
    border-radius: 8px;
    font-weight: 600;
    flex-shrink: 0;
  }
  .bracket-bid.auto {
    background: rgba(63,185,80,.15);
    color: var(--green);
  }
  .bracket-bid.at-large {
    background: rgba(210,153,34,.15);
    color: var(--gold);
  }
  .l4-badge {
    font-size: .6rem;
    padding: 1px 4px;
    border-radius: 6px;
    font-weight: 700;
    background: rgba(248,81,73,.15);
    color: var(--red);
    margin-left: 4px;
    vertical-align: middle;
  }
  .bracket-stat {
    width: 36px;
    text-align: right;
    font-size: .72rem;
    color: var(--text-dim);
    flex-shrink: 0;
    font-variant-numeric: tabular-nums;
  }

  /* seed-line group box */
  .seed-group {
    display: flex;
    align-items: stretch;
    border: 1px solid var(--border);
    border-radius: 6px;
    margin: 4px 6px;
    overflow: hidden;
    background: rgba(88,166,255,.03);
  }
  .seed-group-label {
    display: flex;
    align-items: center;
    justify-content: center;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    padding: 4px 5px;
    font-size: .68rem;
    font-weight: 700;
    color: var(--accent);
    background: rgba(88,166,255,.08);
    border-right: 1px solid var(--border);
    white-space: nowrap;
    letter-spacing: .03em;
    min-width: 22px;
    text-transform: uppercase;
  }
  .seed-group-teams {
    flex: 1;
    min-width: 0;
  }
  .seed-group .bracket-row {
    border-bottom: 1px solid rgba(48,54,61,.5);
    margin: 0;
  }
  .seed-group .bracket-row:last-child { border-bottom: none; }

  /* bubble teams (first/next 4 out) */
  .bubble-section {
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 20px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  .bubble-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .bubble-header {
    padding: 8px 14px;
    font-weight: 700;
    font-size: .82rem;
    text-transform: uppercase;
    letter-spacing: .04em;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
  }
  .bubble-header.first-out {
    color: var(--red);
    background: rgba(248,81,73,.08);
  }
  .bubble-header.next-out {
    color: var(--text-dim);
    background: rgba(139,148,158,.08);
  }
  .bubble-header span:last-child {
    font-size: .7rem;
    color: var(--text-dim);
    letter-spacing: 0;
    text-transform: none;
    display: flex;
    gap: 12px;
  }

  @media (max-width: 1000px) {
    .bracket-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 550px) {
    .bracket-grid { grid-template-columns: 1fr; }
  }

  /* ---------- bubble watch status labels ---------- */
  .bubble-in   { color: var(--green); font-weight: 600; }
  .bubble-aq   { color: var(--green); font-weight: 600; }
  .bubble-f4o  { color: var(--gold); font-weight: 600; }
  .bubble-out  { color: var(--red); }

  /* ---------- seed odds tab ---------- */
  .seed-odds-wrap {
    display: none;
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 20px;
  }
  .seed-odds-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .seed-odds-controls input[type="text"] {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 12px;
    font-size: .9rem;
    width: 280px;
    outline: none;
  }
  .seed-odds-controls input[type="text"]:focus { border-color: var(--accent); }
  .seed-odds-table-wrap { overflow-x: auto; }
  .seed-odds-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .8rem;
  }
  .seed-odds-table thead th {
    background: var(--surface);
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    padding: 8px 6px;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .seed-odds-table thead th:hover { color: var(--accent); }
  .seed-odds-table td {
    padding: 5px 6px;
    border-bottom: 1px solid var(--border);
    text-align: center;
    white-space: nowrap;
  }
  .seed-odds-table td.team-cell {
    text-align: left;
    font-weight: 500;
  }
  .seed-odds-table td.team-cell a {
    color: var(--accent);
    text-decoration: none;
  }
  .seed-odds-table td.team-cell a:hover { text-decoration: underline; }
  .seed-odds-table td.conf-cell { text-align: left; }
  .seed-odds-table td.conf-cell a {
    color: var(--accent);
    text-decoration: none;
  }
  .seed-odds-table tbody tr:hover { background: rgba(88,166,255,.06); }

  /* ---------- comparison tool tab ---------- */
  .compare-wrap {
    display: none;
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 20px;
  }
  .compare-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 14px;
    position: relative;
  }
  .compare-controls input[type="text"] {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 12px;
    font-size: .9rem;
    width: 300px;
    outline: none;
  }
  .compare-controls input[type="text"]:focus { border-color: var(--accent); }
  .compare-autocomplete {
    position: absolute;
    top: 100%;
    left: 0;
    width: 300px;
    max-height: 240px;
    overflow-y: auto;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0 0 6px 6px;
    z-index: 100;
    display: none;
  }
  .compare-autocomplete div {
    padding: 8px 12px;
    cursor: pointer;
    font-size: .85rem;
    color: var(--text);
    display: flex;
    justify-content: space-between;
  }
  .compare-autocomplete div:hover { background: rgba(88,166,255,.12); }
  .compare-autocomplete div .ac-conf { color: var(--text-dim); font-size: .75rem; }

  .compare-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
  }
  .compare-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: 16px;
    padding: 4px 10px 4px 12px;
    font-size: .8rem;
    color: var(--accent);
    font-weight: 600;
  }
  .compare-tag .remove-tag {
    cursor: pointer;
    color: var(--text-dim);
    font-size: .9rem;
    line-height: 1;
    margin-left: 2px;
  }
  .compare-tag .remove-tag:hover { color: var(--red); }
  .compare-clear {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-dim);
    padding: 4px 10px;
    font-size: .75rem;
    cursor: pointer;
  }
  .compare-clear:hover { color: var(--red); border-color: var(--red); }

  .compare-toggle {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-dim);
    padding: 6px 12px;
    font-size: .78rem;
    cursor: pointer;
    white-space: nowrap;
    transition: all .15s;
  }
  .compare-toggle:hover { border-color: var(--accent); color: var(--accent); }
  .compare-toggle.active {
    background: rgba(88,166,255,.12);
    border-color: var(--accent);
    color: var(--accent);
    font-weight: 600;
  }

  /* H/A/N stacked breakdown inside quad cells */
  .han-stack { display: flex; flex-direction: column; gap: 1px; }
  .han-line { display: flex; align-items: center; gap: 4px; font-size: .75rem; white-space: nowrap; }
  .han-label { color: var(--text-dim); font-weight: 600; min-width: 1.4em; text-align: right; }

  .compare-table-wrap { overflow: visible; }
  .compare-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .82rem;
  }
  .compare-table thead th {
    background: var(--surface);
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    padding: 10px 8px;
    white-space: nowrap;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .compare-table td {
    padding: 8px 8px;
    border-bottom: 1px solid var(--border);
    text-align: center;
    white-space: nowrap;
  }
  .compare-table td.team-cell {
    text-align: left;
    font-weight: 500;
  }
  .compare-table td.team-cell a {
    color: var(--accent);
    text-decoration: none;
  }
  .compare-table td.team-cell a:hover { text-decoration: underline; }
  .compare-table tbody tr:hover { background: rgba(88,166,255,.06); }
  .compare-table .best-val { font-weight: 800; color: var(--green); }
  .compare-table th.compare-sortable { cursor: pointer; user-select: none; }
  .compare-table th.compare-sortable:hover { color: var(--accent); }
  .compare-table th.compare-sorted { color: var(--accent); }

  /* game list cells (best wins / worst losses) */
  .compare-table td.game-list-cell {
    white-space: normal;
    min-width: 180px;
    vertical-align: top;
    padding: 6px 8px;
  }
  .game-list-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: .78rem;
    line-height: 1.6;
  }
  .game-list-rank {
    color: var(--text-dim);
    font-size: .72rem;
    min-width: 42px;
    text-align: right;
  }
  .game-list-link {
    color: var(--accent);
    text-decoration: none;
  }
  .game-list-link:hover { text-decoration: underline; }
  .game-list-none {
    color: var(--text-dim);
    font-style: italic;
    font-size: .78rem;
  }

  .compare-empty {
    text-align: center;
    color: var(--text-dim);
    padding: 40px 20px;
    font-size: .95rem;
  }

  /* ---------- team sheets tab ---------- */
  .team-sheets-wrap {
    display: none;
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 20px;
  }
  .team-sheets-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .team-sheets-controls input[type="text"] {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 12px;
    font-size: .9rem;
    width: 280px;
    outline: none;
  }
  .team-sheets-controls input[type="text"]:focus { border-color: var(--accent); }
  .team-sheets-table-wrap { overflow-x: auto; }
  .team-sheets-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .82rem;
  }
  .team-sheets-table thead th {
    background: var(--surface);
    border-bottom: 2px solid var(--border);
    color: var(--text-dim);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .03em;
    padding: 10px 8px;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .team-sheets-table thead th:hover { color: var(--accent); }
  .team-sheets-table td {
    padding: 8px 8px;
    border-bottom: 1px solid var(--border);
    text-align: center;
    white-space: nowrap;
  }
  .team-sheets-table td.team-cell {
    text-align: left;
    font-weight: 500;
  }
  .team-sheets-table td.team-cell a {
    color: var(--accent);
    text-decoration: none;
  }
  .team-sheets-table td.team-cell a:hover { text-decoration: underline; }
  .team-sheets-table td.conf-cell { text-align: left; }
  .team-sheets-table td.conf-cell a {
    color: var(--accent);
    text-decoration: none;
  }
  .team-sheets-table tbody tr:hover { background: rgba(88,166,255,.06); }
  .team-sheets-table .heatmap { border-radius: 4px; }

  /* ---------- mobile responsive ---------- */
  @media (max-width: 768px) {
    header { padding: 16px 16px; }
    header h1 { font-size: 1.15rem; }
    header p { font-size: .75rem; }
    .header-actions { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .header-actions a { font-size: .75rem; padding: 5px 12px; }

    .tabs {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      flex-wrap: nowrap;
      padding: 0 12px;
      gap: 2px;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab-btn {
      padding: 7px 12px;
      font-size: .73rem;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .bracket-wrap { padding: 0 12px; }
    .bubble-section { padding: 0 12px; }

    .seed-odds-wrap { padding: 0 12px; }
    .seed-odds-controls { padding: 0; }
    .seed-odds-controls input[type="text"] { width: 100%; }
    .seed-odds-table { font-size: .7rem; }
    .seed-odds-table thead th { padding: 6px 4px; font-size: .65rem; }
    .seed-odds-table td { padding: 4px 3px; }

    .compare-wrap { padding: 0 12px; }
    .compare-controls input[type="text"] { width: 100%; }
    .compare-autocomplete { width: 100%; }
    .compare-table { font-size: .72rem; }
    .compare-table thead th { padding: 7px 4px; font-size: .68rem; }
    .compare-table td { padding: 6px 4px; }
    .compare-table td.game-list-cell { min-width: 150px; }
    .game-list-item { font-size: .68rem; }
    .game-list-rank { font-size: .64rem; min-width: 22px; }

    .team-sheets-wrap { padding: 0 12px; }
    .team-sheets-controls input[type="text"] { width: 100%; }
    .team-sheets-table { font-size: .72rem; }
    .team-sheets-table thead th { padding: 7px 4px; font-size: .68rem; }
    .team-sheets-table td { padding: 5px 4px; }
  }
</style>
</head>
<body>

<header>
  <h1>üèÄü§ñ AIB College Basketball Ratings ‚Äî 2025-26</h1>
  <p>Opponent-adjusted efficiency ratings and resume ratings ¬∑ Not actually AI ¬∑ Updated through Feb 26, 2026</p>
  <div class="header-actions">
    <a href="game_date.html" id="latestGamesBtn">üìä Latest Game Results</a>
    <a href="blog.html" id="blogBtn">üìù Blog</a>
    <button class="theme-toggle" id="themeToggle" title="Toggle light/dark mode">üåô</button>
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" id="tabRank">Team Rankings</button>
  <button class="tab-btn" id="tabQuad">Quadrant Records</button>
  <button class="tab-btn" id="tabAdvOff">Adv Offensive</button>
  <button class="tab-btn" id="tabAdvDef">Adv Defensive</button>
  <button class="tab-btn" id="tabBrack">Bracketology</button>
  <button class="tab-btn" id="tabBubble">Bubble Watch</button>
  <button class="tab-btn" id="tabSeedOdds">Seed Odds</button>
  <button class="tab-btn" id="tabCompare">Comparison Tool</button>
  <button class="tab-btn" id="tabSheets">Teamsheet Ranks</button>
</div>

<div class="controls">
  <input type="text" id="search" placeholder="Search teams‚Ä¶" autocomplete="off">
  <span class="stat-count" id="rowCount"></span>
</div>

<div class="table-wrap">
  <table id="mainTable">
    <thead>
      <tr id="headerRow"></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="bracket-wrap" id="bracketWrap">
  <div class="bracket-grid" id="bracketGrid"></div>
  <div class="bubble-section" id="bubbleSection"></div>
</div>

<div class="seed-odds-wrap" id="seedOddsWrap">
  <div class="seed-odds-controls">
    <input type="text" id="seedOddsSearch" placeholder="Search teams‚Ä¶" autocomplete="off">
    <span class="stat-count" id="seedOddsCount"></span>
  </div>
  <div class="seed-odds-table-wrap">
    <table class="seed-odds-table" id="seedOddsTable">
      <thead><tr id="seedOddsHeader"></tr></thead>
      <tbody id="seedOddsTbody"></tbody>
    </table>
  </div>
</div>

<div class="compare-wrap" id="compareWrap">
  <div class="compare-controls">
    <input type="text" id="compareSearch" placeholder="Search and add teams‚Ä¶" autocomplete="off">
    <button class="compare-toggle" id="compareSheetToggle">üìã Show Official Teamsheet Ranks</button>
    <button class="compare-toggle" id="compareHANToggle">üìç H/A/N Breakdown</button>
    <div class="compare-autocomplete" id="compareAutocomplete"></div>
  </div>
  <div class="compare-tags" id="compareTags"></div>
  <div class="compare-table-wrap">
    <table class="compare-table" id="compareTable">
      <thead><tr id="compareHeader"></tr></thead>
      <tbody id="compareTbody"></tbody>
    </table>
    <div class="compare-empty" id="compareEmpty">Search for teams above to compare resumes side-by-side</div>
  </div>
</div>

<div class="team-sheets-wrap" id="teamSheetsWrap">
  <p style="color:var(--text-dim);font-size:.8rem;margin-bottom:10px">Data sourced from <a href="https://www.warrennolan.com/basketball/2026/net-teamsheets-plus" style="color:var(--accent);text-decoration:none">Warren Nolan</a></p>
  <div class="team-sheets-controls">
    <input type="text" id="sheetsSearch" placeholder="Search teams‚Ä¶" autocomplete="off">
    <span class="stat-count" id="sheetsCount"></span>
  </div>
  <div class="team-sheets-table-wrap">
    <table class="team-sheets-table" id="sheetsTable">
      <thead>
        <tr id="sheetsSectionRow"></tr>
        <tr id="sheetsHeader"></tr>
      </thead>
      <tbody id="sheetsTbody"></tbody>
    </table>
  </div>
</div>

<footer>
  Built by <a href="https://github.com/ai-bracketology">AI Bracketology</a> ¬∑ Data sourced from ESPN
</footer>

<script>
/* ---- theme toggle ---- */
(function initThemeToggle() {
  const btn = document.getElementById("themeToggle");
  const isLight = document.documentElement.getAttribute("data-theme") === "light";
  btn.textContent = isLight ? "‚òÄÔ∏è" : "üåô";
  btn.addEventListener("click", () => {
    const nowLight = document.documentElement.getAttribute("data-theme") === "light";
    if (nowLight) {
      document.documentElement.removeAttribute("data-theme");
      localStorage.setItem("cbb_theme", "dark");
      btn.textContent = "üåô";
    } else {
      document.documentElement.setAttribute("data-theme", "light");
      localStorage.setItem("cbb_theme", "light");
      btn.textContent = "‚òÄÔ∏è";
    }
  });
})();

/* ---- column definitions ---- */

/* Tab 1: Team Rankings ‚Äî Efficiency + Resume sections */
const RANK_COLS = [
  { key: "_rank",            label: "#",            fmt: v => v,              align: "center", rankKey: "rank_net" },
  { key: "team_displayName", label: "Team",         fmt: v => v,              align: "left" },
  { key: "proj_seed",        label: "Proj Seed",    fmt: v => v ?? "",        align: "center" },
  { key: "conference",       label: "Conf",         fmt: v => v ?? "‚Äì",       align: "left" },
  { key: "record",           label: "Record",       fmt: v => v ?? "‚Äì",       align: "center" },
  { key: "conf_record",      label: "Conf",         fmt: v => v ?? "‚Äì",       align: "center" },
  { key: "streak",           label: "Streak",       fmt: v => v ?? "‚Äì",       align: "center", sortKey: "streak_num", cls: v => v?.[0] === "W" ? "net-pos" : v?.[0] === "L" ? "net-neg" : "" },
  /* Efficiency */
  { key: "Tempo_srs",        label: "Adj T",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_tempo", sectionStart: true, section: "Efficiency" },
  { key: "OffEff_srs",       label: "Adj OE",       fmt: v => v?.toFixed(2),  cls: v => v > 100 ? "eff-good" : v < 100 ? "eff-bad" : "", heat: "high", rank: "rank_off" },
  { key: "DefEff_srs",       label: "Adj DE",       fmt: v => v?.toFixed(2),  cls: v => v < 100 ? "eff-good" : v > 100 ? "eff-bad" : "", heat: "low",  rank: "rank_def" },
  { key: "net_srs",          label: "Total AdjE",   fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_net", sectionEnd: true },
  /* Resume */
  { key: "sos",              label: "SOS",           fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_sos",    sectionStart: true, section: "Resume" },
  { key: "nc_sos",           label: "NC SOS",        fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_nc_sos" },
  { key: "season_wab",       label: "WAB",           fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_wab" },
  { key: "slct",             label: "SLCT",          fmt: v => v?.toFixed(2),  heat: "high", rank: "rank_slct" },
  { key: "seed",             label: "SEED",          fmt: v => v?.toFixed(2),  heat: "high", rank: "rank_seed", sectionEnd: true },
];

/* Tab 3: Quadrant Records ‚Äî sorted by WAB rank */
const QUAD_COLS = [
  { key: "_rank",            label: "#",            fmt: v => v,              align: "center", rankKey: "rank_wab" },
  { key: "team_displayName", label: "Team",         fmt: v => v,              align: "left" },
  { key: "proj_seed",        label: "Proj Seed",    fmt: v => v ?? "",        align: "center" },
  { key: "conference",       label: "Conf",         fmt: v => v ?? "‚Äì",       align: "left" },
  { key: "record",           label: "Record",       fmt: v => v ?? "‚Äì",       align: "center" },
  { key: "q1a_record",       label: "Q1A",          fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q1a_w", quadTip: "q1a" },
  { key: "q1_record",        label: "Q1",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q1_w",  quadTip: 1 },
  { key: "q2_record",        label: "Q2",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q2_w",  quadTip: 2 },
  { key: "q12_record",       label: "Q1+Q2",        fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q12_w" },
  { key: "q3_record",        label: "Q3",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q3_w",  quadTip: 3 },
  { key: "q4_record",        label: "Q4",           fmt: v => v ?? "‚Äì",       align: "center", sortKey: "q4_w",  quadTip: 4 },
  { key: "season_wab",       label: "WAB",          fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", heat: "high", rank: "rank_wab" },
];

/* Tab 4: Advanced Offensive Stats ‚Äî sorted by Adj OE rank */
const ADV_OFF_COLS = [
  { key: "_rank",            label: "#",           fmt: v => v,              align: "center", rankKey: "rank_off", width: "36px" },
  { key: "team_displayName", label: "Team",        fmt: v => v,              align: "left",   width: "160px" },
  { key: "conference",       label: "Conf",        fmt: v => v ?? "‚Äì",       align: "left",   width: "100px" },
  /* Shooting */
  { key: "adv_efg_pct",      label: "eFG%",        fmt: v => v?.toFixed(1),  heat: "high", sectionStart: true, section: "Shooting",       rank: "rank_adv_efg_pct" },
  { key: "adv_3pt_rate",     label: "3PT Rate",    fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_3pt_rate" },
  { key: "adv_3pt_pct",      label: "3PT%",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_3pt_pct" },
  { key: "adv_ftr",          label: "FTR",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_ftr" },
  { key: "adv_ft_pct",       label: "FT%",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_ft_pct", sectionEnd: true },
  /* Ball Control */
  { key: "adv_ast_rate",     label: "AST Rate",    fmt: v => v?.toFixed(1),  heat: "high", sectionStart: true, section: "Ball Control",   rank: "rank_adv_ast_rate" },
  { key: "adv_or_pct",       label: "OR%",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_or_pct" },
  { key: "adv_dr_pct",       label: "DR%",         fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_dr_pct" },
  { key: "adv_off_to_pct",   label: "Off TO%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_adv_off_to_pct" },
  { key: "adv_stl_pct",      label: "STL%",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_stl_pct" },
  { key: "adv_blk_pct",      label: "BLK%",        fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_blk_pct", sectionEnd: true },
  /* Scoring Breakdown */
  { key: "adv_to_pts_pct",   label: "TO Pts %",    fmt: v => v?.toFixed(1),  heat: "high", sectionStart: true, section: "Scoring Breakdown", rank: "rank_adv_to_pts_pct" },
  { key: "adv_fb_pts_pct",   label: "FSTBRK %",    fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_fb_pts_pct" },
  { key: "adv_pip_pct",      label: "Paint %",     fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_adv_pip_pct", sectionEnd: true },
  /* Adj OE */
  { key: "OffEff_srs",       label: "Adj OE",      fmt: v => v?.toFixed(2),  cls: v => v > 100 ? "eff-good" : v < 100 ? "eff-bad" : "", heat: "high", rank: "rank_off" },
];

/* Tab 5: Advanced Defensive Stats ‚Äî sorted by Adj DE rank */
const ADV_DEF_COLS = [
  { key: "_rank",            label: "#",           fmt: v => v,              align: "center", rankKey: "rank_def", width: "36px" },
  { key: "team_displayName", label: "Team",        fmt: v => v,              align: "left",   width: "160px" },
  { key: "conference",       label: "Conf",        fmt: v => v ?? "‚Äì",       align: "left",   width: "100px" },
  /* Opp Shooting */
  { key: "def_efg_pct",      label: "Opp eFG%",    fmt: v => v?.toFixed(1),  heat: "low",  sectionStart: true, section: "Opp Shooting",       rank: "rank_def_efg_pct" },
  { key: "def_3pt_rate",     label: "Opp 3PT Rate", fmt: v => v?.toFixed(1), heat: "low",  rank: "rank_def_3pt_rate" },
  { key: "def_3pt_pct",      label: "Opp 3PT%",    fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_3pt_pct" },
  { key: "def_ftr",          label: "Opp FTR",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_ftr" },
  { key: "def_ft_pct",       label: "Opp FT%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_ft_pct", sectionEnd: true },
  /* Opp Ball Control */
  { key: "def_ast_rate",     label: "Opp AST Rate", fmt: v => v?.toFixed(1), heat: "low",  sectionStart: true, section: "Opp Ball Control",   rank: "rank_def_ast_rate" },
  { key: "def_or_pct",       label: "Opp OR%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_or_pct" },
  { key: "def_dr_pct",       label: "Opp DR%",     fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_dr_pct" },
  { key: "def_off_to_pct",   label: "Opp TO%",     fmt: v => v?.toFixed(1),  heat: "high", rank: "rank_def_off_to_pct" },
  { key: "def_stl_pct",      label: "Opp STL%",    fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_stl_pct" },
  { key: "def_blk_pct",      label: "Opp BLK%",    fmt: v => v?.toFixed(1),  heat: "low",  rank: "rank_def_blk_pct", sectionEnd: true },
  /* Opp Scoring Breakdown */
  { key: "def_to_pts_pct",   label: "Opp TO Pts %", fmt: v => v?.toFixed(1), heat: "low",  sectionStart: true, section: "Opp Scoring Breakdown", rank: "rank_def_to_pts_pct" },
  { key: "def_fb_pts_pct",   label: "Opp FSTBRK %", fmt: v => v?.toFixed(1), heat: "low",  rank: "rank_def_fb_pts_pct" },
  { key: "def_pip_pct",      label: "Opp Paint %",  fmt: v => v?.toFixed(1), heat: "low",  rank: "rank_def_pip_pct", sectionEnd: true },
  /* Adj DE */
  { key: "DefEff_srs",       label: "Adj DE",      fmt: v => v?.toFixed(2),  cls: v => v < 100 ? "eff-good" : v > 100 ? "eff-bad" : "", heat: "low", rank: "rank_def" },
];

/* Tab 7: Bubble Watch */
const BUBBLE_COLS = [
  { key: "rank_slct",        label: "#",            fmt: v => v,               align: "center" },
  { key: "team_displayName", label: "Team",         fmt: v => v,               align: "left" },
  { key: "_status",          label: "Status",       fmt: v => v ?? "",         align: "center" },
  { key: "conference",       label: "Conf",         fmt: v => v ?? "‚Äì",        align: "left" },
  { key: "record",           label: "Record",       fmt: v => v ?? "‚Äì",        align: "center" },
  { key: "streak",           label: "Streak",       fmt: v => v ?? "‚Äì",        align: "center", sortKey: "streak_num", cls: v => v?.[0] === "W" ? "net-pos" : v?.[0] === "L" ? "net-neg" : "" },
  { key: "net_srs",          label: "Total AdjE",   fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "" },
  { key: "sos",              label: "SOS",           fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", rank: "rank_sos" },
  { key: "nc_sos",           label: "NC SOS",        fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", rank: "rank_nc_sos" },
  { key: "season_wab",       label: "WAB",           fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", rank: "rank_wab" },
  { key: "q1a_record",       label: "Q1A",           fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q1a_w" },
  { key: "q1_record",        label: "Q1",            fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q1_w" },
  { key: "q2_record",        label: "Q2",            fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q2_w" },
  { key: "q12_record",       label: "Q1+Q2",         fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q12_w" },
  { key: "q3_record",        label: "Q3",            fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q3_w" },
  { key: "q4_record",        label: "Q4",            fmt: v => v ?? "‚Äì",  align: "center", sortKey: "q4_w" },
  { key: "slct",             label: "SLCT",           fmt: v => v?.toFixed(2), heat: "high" },
  { key: "seed",             label: "SEED",           fmt: v => v?.toFixed(2), heat: "high" },
];

let DATA = [];
let SIM_DATA = [];
let activeTab = "rank";   // "rank", "quad", "advOff", "advDef", "brack", "bubble", "seedOdds", "compare", "sheets"
let sortCol = "net_srs";
let sortAsc = false;
let seedOddsSortCol = "make_pct";
let seedOddsSortAsc = false;
let sheetsSortCol = "NET";
let sheetsSortAsc = true;

/* ---- restore saved sort/tab state ---- */
(function restoreState() {
  try {
    const s = JSON.parse(localStorage.getItem("cbb_index_state"));
    if (s) {
      activeTab = s.activeTab || activeTab;
      sortCol = s.sortCol || sortCol;
      sortAsc = s.sortAsc ?? sortAsc;
      seedOddsSortCol = s.seedOddsSortCol || seedOddsSortCol;
      seedOddsSortAsc = s.seedOddsSortAsc ?? seedOddsSortAsc;
      sheetsSortCol = s.sheetsSortCol || sheetsSortCol;
      sheetsSortAsc = s.sheetsSortAsc ?? sheetsSortAsc;
    }
  } catch(e) {}
})();
function saveState() {
  localStorage.setItem("cbb_index_state", JSON.stringify({
    activeTab, sortCol, sortAsc, seedOddsSortCol, seedOddsSortAsc, sheetsSortCol, sheetsSortAsc
  }));
}

function getCols() {
  if (activeTab === "quad") return QUAD_COLS;
  if (activeTab === "advOff") return ADV_OFF_COLS;
  if (activeTab === "advDef") return ADV_DEF_COLS;
  if (activeTab === "bubble") return BUBBLE_COLS;
  return RANK_COLS;
}

/* ---- fetch data ---- */
fetch("data.json")
  .then(r => r.json())
  .then(d => {
    DATA = d;
    /* apply restored tab/sort state */
    const saved = activeTab;
    activeTab = "__force__";          // force switchTab to run even if same
    switchTab(saved, sortCol, sortAsc);
  })
  .catch(e => { document.getElementById("tbody").innerHTML = `<tr><td colspan="8">Failed to load data: ${e}</td></tr>`; });

fetch("sim_results.json")
  .then(r => r.json())
  .then(d => { SIM_DATA = d; })
  .catch(() => { SIM_DATA = []; });

let GAMES_DATA = {};
fetch("games.json")
  .then(r => r.json())
  .then(d => { GAMES_DATA = d; })
  .catch(() => { GAMES_DATA = {}; });

let NET_RANKS = {};
fetch("net_rankings.json")
  .then(r => r.json())
  .then(d => { NET_RANKS = d; })
  .catch(() => { NET_RANKS = {}; });

let SHEETS_DATA = [];
fetch("teamsheets.json")
  .then(r => r.json())
  .then(d => {
    /* convert {abbr: {team, NET, KPI, ...}} to array with team_abbr */
    SHEETS_DATA = Object.entries(d).map(([abbr, obj]) => ({
      team_abbr: abbr,
      team_displayName: obj.team,
      ...obj,
    }));
    /* look up conf from DATA if available */
    const confLookup = {};
    DATA.forEach(t => { confLookup[t.team_abbr] = t.conference; });
    SHEETS_DATA.forEach(s => { s.conference = confLookup[s.team_abbr] || ""; });
  })
  .catch(() => { SHEETS_DATA = []; });

/* ---- heatmap helper ---- */
function heatColor(val, min, max, invert) {
  if (val == null || min === max) return "";
  let t = (val - min) / (max - min);
  if (invert) t = 1 - t;
  // dark blue (13,27,42) ‚Üí light blue (88,166,255)
  const r = Math.round(13 + (88 - 13) * t);
  const g = Math.round(27 + (166 - 27) * t);
  const b = Math.round(42 + (255 - 42) * t);
  return `rgba(${r},${g},${b},0.25)`;
}

/* ---- build header ---- */
function buildHeader() {
  const thead = document.getElementById("headerRow").parentElement;
  thead.innerHTML = "";
  const COLS = getCols();
  const hasSections = COLS.some(c => c.section);

  // Section header row for tabs with grouped sections
  if (hasSections) {
    const sectionRow = document.createElement("tr");
    // Count non-section leading cols
    let leadCols = 0;
    for (const c of COLS) { if (!c.section) leadCols++; else break; }
    // Blank header for leading cols
    if (leadCols > 0) {
      const blankTh = document.createElement("th");
      blankTh.setAttribute("colspan", leadCols);
      blankTh.style.borderBottom = "none";
      sectionRow.appendChild(blankTh);
    }
    // Gather sections from remaining cols
    let curSection = null, curSpan = 0, sections = [], sectionClosed = false;
    COLS.slice(leadCols).forEach(c => {
      if (c.section && c.section !== curSection) {
        // New named section ‚Äî push previous if any
        if (curSection !== null) sections.push({ label: curSection, span: curSpan });
        else if (sectionClosed && curSpan > 0) sections.push({ label: "", span: curSpan });
        curSection = c.section;
        curSpan = 0;
        sectionClosed = false;
      }
      curSpan++;
      if (c.sectionEnd) {
        sections.push({ label: curSection, span: curSpan });
        curSection = null;
        curSpan = 0;
        sectionClosed = true;
      }
    });
    // Flush any remaining cols
    if (curSection !== null) sections.push({ label: curSection, span: curSpan });
    else if (curSpan > 0) sections.push({ label: "", span: curSpan });
    sections.forEach(s => {
      const th = document.createElement("th");
      th.setAttribute("colspan", s.span);
      if (s.label) {
        th.style.background = "rgba(88,166,255,.06)";
        th.style.color = "var(--text-dim)";
        th.style.fontSize = ".7rem";
        th.style.fontWeight = "700";
        th.style.textTransform = "uppercase";
        th.style.letterSpacing = ".05em";
        th.style.borderBottom = "2px solid var(--accent)";
        th.style.padding = "3px 7px";
        th.textContent = s.label;
      } else {
        th.style.borderBottom = "none";
      }
      sectionRow.appendChild(th);
    });
    thead.appendChild(sectionRow);
  }

  const tr = document.createElement("tr");
  tr.id = "headerRow";
  COLS.forEach(c => {
    const th = document.createElement("th");
    th.textContent = c.label;
    th.style.textAlign = c.align || "center";
    if (c.sectionStart) th.classList.add("section-start");
    if (c.sectionEnd) th.classList.add("section-end");
    if (c.width) th.style.width = c.width;
    th.addEventListener("click", () => {
      if (sortCol === c.key) sortAsc = !sortAsc;
      else { sortCol = c.key; sortAsc = c.key === "team_displayName"; }
      saveState();
      render();
    });
    tr.appendChild(th);
  });
  thead.appendChild(tr);
}

/* ---- quadrant tooltip helpers ---- */
function isQ1A(location, oppRank) {
  if (oppRank == null) return false;
  if (location === "home") return oppRank <= 15;
  if (location === "away") return oppRank <= 40;
  return oppRank <= 25; // neutral
}

/* Official NCAA quad classification based on NET rankings */
function getOfficialQuad(homeAway, oppNetRank) {
  if (oppNetRank == null) return null;
  if (homeAway === "home") {
    if (oppNetRank <= 30)  return 1;
    if (oppNetRank <= 75)  return 2;
    if (oppNetRank <= 160) return 3;
    return 4;
  } else if (homeAway === "away") {
    if (oppNetRank <= 75)  return 1;
    if (oppNetRank <= 135) return 2;
    if (oppNetRank <= 240) return 3;
    return 4;
  } else { /* neutral */
    if (oppNetRank <= 50)  return 1;
    if (oppNetRank <= 100) return 2;
    if (oppNetRank <= 200) return 3;
    return 4;
  }
}

function getQuadGames(abbr, quadTip, useNet) {
  const games = GAMES_DATA[abbr];
  if (!games) return [];
  return games.filter(g => {
    if (quadTip === "q1a") return isQ1A(g.homeAway, useNet ? (NET_RANKS[g.opp_team_abbr] ?? null) : g.opp_seed_rank);
    if (useNet) {
      const netRank = NET_RANKS[g.opp_team_abbr];
      return getOfficialQuad(g.homeAway, netRank) === quadTip;
    }
    return g.quad === quadTip;
  });
}

function buildQuadTip(abbr, quadTip, useNet) {
  const games = getQuadGames(abbr, quadTip, useNet);
  if (games.length === 0) return "";
  const lines = games.map(g => {
    const won = g._won;
    const cls = won ? "quad-tip-win" : "quad-tip-loss";
    const result = won ? "W" : "L";
    const loc = g.homeAway === "away" ? "@" : g.homeAway === "home" ? "vs" : "vs (N)";
    const rank = useNet ? (NET_RANKS[g.opp_team_abbr] ?? "‚Äì") : (g.opp_seed_rank ?? "‚Äì");
    const name = g.opp_team_abbr || "‚Äì";
    const score = `${Math.round(g.points)}-${Math.round(g.points_allowed)}`;
    return `<div class="quad-tip-game ${cls}"><span class="quad-tip-loc">${loc}</span><span class="quad-tip-rank">#${rank}</span> <a href="team.html?team=${encodeURIComponent(g.opp_team_abbr)}">${name}</a> <span>${result} ${score}</span></div>`;
  }).join("");
  return `<div class="quad-tip">${lines}</div>`;
}

/* ---- render table ---- */
function render() {
  const COLS = getCols();
  const q = document.getElementById("search").value.toLowerCase();
  let rows = DATA;

  /* bubble tab: filter to SLCT rank 37-58 and add status labels */
  if (activeTab === "bubble") {
    rows = rows.filter(r => r.rank_slct >= 37 && r.rank_slct <= 58);
    rows = rows.map(r => {
      const s = { ...r };
      if (r.bracket === "at-large") s._status = "‚úÖ In - " + (r.proj_seed ?? "?");
      else if (r.bracket === "auto") s._status = "üèÜ AQ";
      else if (r.bracket === "first_four_out") s._status = "‚ö†Ô∏è F4O";
      else if (r.bracket === "next_four_out") s._status = "‚ùå N4O";
      else s._status = "‚ùå Out";
      return s;
    });
  }

  if (q) rows = rows.filter(r => r.team_displayName?.toLowerCase().includes(q) || r.team_abbr?.toLowerCase().includes(q));

  rows = [...rows].sort((a, b) => {
    const colDef = COLS.find(c => c.key === sortCol);
    const sk = colDef?.sortKey || (sortCol === "_rank" ? colDef?.rankKey : null) || sortCol;
    let va = a[sk], vb = b[sk];
    if (va == null) return 1; if (vb == null) return -1;
    if (typeof va === "string") { va = va.toLowerCase(); vb = (vb || "").toLowerCase(); }
    return sortAsc ? (va > vb ? 1 : va < vb ? -1 : 0) : (va < vb ? 1 : va > vb ? -1 : 0);
  });

  // compute heatmap min/max for each column that has a heat property
  const bounds = {};
  COLS.forEach(c => {
    if (!c.heat) return;
    const vals = rows.map(r => r[c.key]).filter(v => v != null);
    if (vals.length) { bounds[c.key] = { min: Math.min(...vals), max: Math.max(...vals) }; }
  });

  const tbody = document.getElementById("tbody");
  const frags = [];
  rows.forEach((r, i) => {
    const cells = COLS.map(c => {
      const v = c.key === "_rank" ? r[c.rankKey || "rank_net"] : r[c.key];
      let display = v != null ? c.fmt(v) : "‚Äì";
      if (c.key === "team_displayName" && r.team_abbr) {
        const mIcon = r.momentum_l5 >= 90 ? " üî•" : r.momentum_l5 <= 10 ? " ‚ùÑÔ∏è" : "";
        display = `<a href="team.html?team=${encodeURIComponent(r.team_abbr)}" style="color:var(--accent);text-decoration:none">${display}</a>${mIcon}`;
      }
      if (c.key === "conference" && v) {
        display = `<a href="conference.html?conf=${encodeURIComponent(v)}" style="color:var(--accent);text-decoration:none">${display}</a>`;
      }
      if (c.rank && r[c.rank] != null) {
        display += `<span class="rk">${r[c.rank]}</span>`;
      }
      let cls = (c.cls ? c.cls(v) : "");
      if (c.key === "_status" && v) {
        if (v.includes("In")) cls += " bubble-in";
        else if (v.includes("AQ")) cls += " bubble-aq";
        else if (v.includes("F4O")) cls += " bubble-f4o";
        else cls += " bubble-out";
      }
      const align = c.align || "center";
      let style = `text-align:${align}`;
      if (c.heat && v != null && bounds[c.key]) {
        const bg = heatColor(v, bounds[c.key].min, bounds[c.key].max, c.heat === "low");
        if (bg) style += `;background:${bg}`;
      }
      /* quadrant tooltip */
      if (c.quadTip != null && r.team_abbr) {
        const tip = buildQuadTip(r.team_abbr, c.quadTip);
        if (tip) {
          const belowCls = i < 10 ? ' quad-tip-below' : '';
          return `<td style="${style}" class="quad-tip-cell${belowCls} ${cls} ${c.sectionStart ? 'section-start' : ''} ${c.sectionEnd ? 'section-end' : ''}">${display}${tip}</td>`;
        }
      }
      return `<td style="${style}" class="${cls} ${c.heat ? 'heatmap' : ''} ${c.sectionStart ? 'section-start' : ''} ${c.sectionEnd ? 'section-end' : ''}">${display}</td>`;
    }).join("");
    frags.push(`<tr>${cells}</tr>`);
  });
  tbody.innerHTML = frags.join("");
  document.getElementById("rowCount").textContent = `${rows.length} teams`;

  // update header arrows
  document.querySelectorAll("#headerRow th").forEach((th, i) => {
    const col = COLS[i];
    const arrow = col.key === sortCol ? (sortAsc ? " ‚ñ≤" : " ‚ñº") : "";
    th.textContent = col.label + arrow;
  });
}

/* ---- seed odds table ---- */
const SEED_ODDS_COLS = [
  { key: "current_slct_rank", label: "#",        sortable: true },
  { key: "team_displayName",  label: "Team",     sortable: true, align: "left" },
  { key: "conference",        label: "Conf",     sortable: true, align: "left" },
  { key: "remaining_games",   label: "Rem",      sortable: true },
  { key: "make_pct",          label: "Make%",    sortable: true, fmt: v => v.toFixed(1) + "%", heat: true },
  { key: "avg_seed_if_make",  label: "Avg",      sortable: true, fmt: v => v != null ? v.toFixed(1) : "‚Äì" },
  { key: "most_likely_seed",  label: "MLS",      sortable: true, fmt: v => v ?? "‚Äì" },
  { key: "seed_1_pct",  label: "1",  sortable: true, seed: true },
  { key: "seed_2_pct",  label: "2",  sortable: true, seed: true },
  { key: "seed_3_pct",  label: "3",  sortable: true, seed: true },
  { key: "seed_4_pct",  label: "4",  sortable: true, seed: true },
  { key: "seed_5_pct",  label: "5",  sortable: true, seed: true },
  { key: "seed_6_pct",  label: "6",  sortable: true, seed: true },
  { key: "seed_7_pct",  label: "7",  sortable: true, seed: true },
  { key: "seed_8_pct",  label: "8",  sortable: true, seed: true },
  { key: "seed_9_pct",  label: "9",  sortable: true, seed: true },
  { key: "seed_10_pct", label: "10", sortable: true, seed: true },
  { key: "seed_11_plus", label: "11+", sortable: true, seed: true },
  { key: "out_pct",     label: "Out", sortable: true, seed: true },
];

function seedHeat(v) {
  if (v == null || v === 0) return "";
  /* green intensity scaled by probability: 0 ‚Üí transparent, 100 ‚Üí full green */
  const t = Math.min(v / 100, 1);
  const alpha = 0.08 + t * 0.55;
  return `rgba(63,185,80,${alpha.toFixed(2)})`;
}

function outHeat(v) {
  if (v == null || v === 0) return "";
  const t = Math.min(v / 100, 1);
  const alpha = 0.08 + t * 0.55;
  return `rgba(248,81,73,${alpha.toFixed(2)})`;
}

function renderSeedOdds() {
  if (!SIM_DATA.length) return;

  /* pre-compute 11+ column */
  const rows = SIM_DATA.map(r => ({
    ...r,
    seed_11_plus: (r.seed_11_pct || 0) + (r.seed_12_pct || 0) + (r.seed_13_pct || 0) + (r.seed_14_pct || 0) + (r.seed_15_pct || 0) + (r.seed_16_pct || 0),
  }));

  /* filter by search */
  const q = document.getElementById("seedOddsSearch").value.toLowerCase();
  let filtered = rows;
  if (q) filtered = filtered.filter(r => r.team_displayName?.toLowerCase().includes(q) || r.team_abbr?.toLowerCase().includes(q));

  /* sort */
  filtered = [...filtered].sort((a, b) => {
    let va = a[seedOddsSortCol], vb = b[seedOddsSortCol];
    if (va == null) return 1; if (vb == null) return -1;
    if (typeof va === "string") { va = va.toLowerCase(); vb = (vb || "").toLowerCase(); }
    return seedOddsSortAsc ? (va > vb ? 1 : va < vb ? -1 : 0) : (va < vb ? 1 : va > vb ? -1 : 0);
  });

  /* filter out teams with negligible make% unless searching */
  if (!q) filtered = filtered.filter(r => r.make_pct >= 0.5);

  /* build header */
  const thead = document.getElementById("seedOddsHeader");
  thead.innerHTML = "";
  SEED_ODDS_COLS.forEach(c => {
    const th = document.createElement("th");
    const arrow = c.key === seedOddsSortCol ? (seedOddsSortAsc ? " ‚ñ≤" : " ‚ñº") : "";
    th.textContent = c.label + arrow;
    if (c.align) th.style.textAlign = c.align;
    th.addEventListener("click", () => {
      if (seedOddsSortCol === c.key) seedOddsSortAsc = !seedOddsSortAsc;
      else { seedOddsSortCol = c.key; seedOddsSortAsc = c.key === "team_displayName"; }
      saveState();
      renderSeedOdds();
    });
    thead.appendChild(th);
  });

  /* build rows */
  const tbody = document.getElementById("seedOddsTbody");
  const frags = [];
  filtered.forEach(r => {
    const cells = SEED_ODDS_COLS.map(c => {
      const v = r[c.key];
      let display, style = "", cls = "";

      if (c.key === "team_displayName") {
        display = `<a href="team.html?team=${encodeURIComponent(r.team_abbr)}">${v}</a>`;
        cls = "team-cell";
      } else if (c.key === "conference") {
        display = v ? `<a href="conference.html?conf=${encodeURIComponent(v)}">${v}</a>` : "‚Äì";
        cls = "conf-cell";
      } else if (c.seed) {
        display = v != null && v > 0 ? v.toFixed(1) : "";
        const bg = c.key === "out_pct" ? outHeat(v) : seedHeat(v);
        if (bg) style = `background:${bg}`;
      } else if (c.heat) {
        display = c.fmt ? c.fmt(v) : v;
        const bg = seedHeat(v);
        if (bg) style = `background:${bg}`;
      } else {
        display = c.fmt ? c.fmt(v) : (v ?? "‚Äì");
      }

      const align = c.align || "center";
      return `<td class="${cls}" style="text-align:${align};${style}">${display}</td>`;
    }).join("");
    frags.push(`<tr>${cells}</tr>`);
  });
  tbody.innerHTML = frags.join("");
  document.getElementById("seedOddsCount").textContent = `${filtered.length} teams`;
}

/* ---- team sheets table ---- */
const RES_COLS = [
  { key: "KPI",  label: "KPI",  sectionStart: true, section: "Result-Based" },
  { key: "SOR",  label: "SOR" },
  { key: "WAB",  label: "WAB" },
];
const PRED_COLS = [
  { key: "BPI",  label: "BPI",  sectionStart: true, section: "Predictive" },
  { key: "POM",  label: "KP" },
  { key: "TRK",  label: "TRK" },
];
const ALL_METRIC_COLS = [...RES_COLS, ...PRED_COLS];

function sheetsRankHeat(rank, maxRank) {
  /* rank 1 = best (bright green), high rank = worst (bright red)
     Scale relative to # of teams we have, not the raw max rank,
     so top teams get vivid green and bottom teams get vivid red */
  if (rank == null || maxRank <= 1) return "";
  const n = maxRank;  // already capped to team count by caller
  const t = Math.min((rank - 1) / (n - 1), 1);   // 0 = best, 1 = worst
  if (t <= 0.5) {
    const s = t / 0.5;
    const r = Math.round(63 + (100 - 63) * s);
    const g = Math.round(185 + (140 - 185) * s);
    const b = Math.round(80 + (90 - 80) * s);
    const a = (0.40 - 0.15 * s).toFixed(2);
    return `rgba(${r},${g},${b},${a})`;
  } else {
    const s = (t - 0.5) / 0.5;
    const r = Math.round(180 + (248 - 180) * s);
    const g = Math.round(120 + (81 - 120) * s);
    const b = Math.round(90 + (73 - 90) * s);
    const a = (0.25 + 0.20 * s).toFixed(2);
    return `rgba(${r},${g},${b},${a})`;
  }
}

function renderTeamSheets() {
  if (!SHEETS_DATA.length) return;

  /* re-attach conf + proj_seed from DATA (in case DATA loaded after SHEETS_DATA) */
  const dataLookup = {};
  DATA.forEach(t => { dataLookup[t.team_abbr] = t; });
  SHEETS_DATA.forEach(s => {
    const d = dataLookup[s.team_abbr];
    if (d) {
      if (!s.conference) s.conference = d.conference || "";
      s.proj_seed = d.proj_seed ?? null;
    }
  });

  /* filter by search */
  const q = document.getElementById("sheetsSearch").value.toLowerCase();
  let rows = SHEETS_DATA;
  if (q) rows = rows.filter(r => r.team_displayName?.toLowerCase().includes(q) || r.team_abbr?.toLowerCase().includes(q) || r.conference?.toLowerCase().includes(q));

  /* compute avgs for each row */
  rows.forEach(r => {
    r._resAvg = RES_COLS.reduce((sum, c) => sum + (r[c.key] || 0), 0) / RES_COLS.length;
    r._predAvg = PRED_COLS.reduce((sum, c) => sum + (r[c.key] || 0), 0) / PRED_COLS.length;
  });

  /* sort */
  rows = [...rows].sort((a, b) => {
    let va = a[sheetsSortCol], vb = b[sheetsSortCol];
    if (sheetsSortCol === "team_displayName" || sheetsSortCol === "conference") {
      va = (va || "").toLowerCase(); vb = (vb || "").toLowerCase();
    }
    if (va == null) return 1; if (vb == null) return -1;
    return sheetsSortAsc ? (va > vb ? 1 : va < vb ? -1 : 0) : (va < vb ? 1 : va > vb ? -1 : 0);
  });

  /* compute heatmap scale: use # of teams so colors span the full
     range of teams we actually have, not raw rank values (which go to 300+) */
  const nTeams = SHEETS_DATA.length;  // ~118
  const maxRanks = {};
  ALL_METRIC_COLS.forEach(c => { maxRanks[c.key] = nTeams; });
  maxRanks.NET = nTeams;
  const resAvgMax = nTeams;
  const predAvgMax = nTeams;

  /* ---- section header row ---- */
  /* Layout: #, Team, Conf, Seed, NET, | KPI SOR WAB ResAvg |, | BPI KP TRK PredAvg | */
  const sectionRow = document.getElementById("sheetsSectionRow");
  sectionRow.innerHTML = "";

  const sectionStyle = (th, label) => {
    th.style.background = "rgba(88,166,255,.06)";
    th.style.color = "var(--text-dim)";
    th.style.fontSize = ".7rem";
    th.style.fontWeight = "700";
    th.style.textTransform = "uppercase";
    th.style.letterSpacing = ".05em";
    th.style.borderBottom = "2px solid var(--accent)";
    th.style.padding = "3px 7px";
    th.textContent = label;
  };

  // 5 leading cols: #, Team, Conf, Seed, NET
  const blankTh = document.createElement("th");
  blankTh.setAttribute("colspan", "5");
  blankTh.style.borderBottom = "none";
  sectionRow.appendChild(blankTh);

  // Result-Based: KPI, SOR, WAB, Res Avg = 4 cols
  const rbTh = document.createElement("th");
  rbTh.setAttribute("colspan", "4");
  sectionStyle(rbTh, "Result-Based");
  sectionRow.appendChild(rbTh);

  // Predictive: BPI, KP, TRK, Pred Avg = 4 cols
  const prTh = document.createElement("th");
  prTh.setAttribute("colspan", "4");
  sectionStyle(prTh, "Predictive");
  sectionRow.appendChild(prTh);

  /* ---- column header row ---- */
  const allCols = [
    { key: "_rank",            label: "#",      sortKey: "NET" },
    { key: "team_displayName", label: "Team" },
    { key: "conference",       label: "Conf" },
    { key: "proj_seed",        label: "AIB Proj Seed" },
    { key: "NET",              label: "NET" },
    ...RES_COLS,
    { key: "_resAvg",          label: "Res Avg", sectionEnd: true },
    ...PRED_COLS,
    { key: "_predAvg",         label: "Pred Avg", sectionEnd: true },
  ];

  const headerRow = document.getElementById("sheetsHeader");
  headerRow.innerHTML = "";
  allCols.forEach(c => {
    const th = document.createElement("th");
    const sk = c.sortKey || c.key;
    const arrow = sk === sheetsSortCol ? (sheetsSortAsc ? " ‚ñ≤" : " ‚ñº") : "";
    th.textContent = c.label + arrow;
    if (c.key === "team_displayName" || c.key === "conference") th.style.textAlign = "left";
    if (c.sectionStart) th.classList.add("section-start");
    if (c.sectionEnd) th.classList.add("section-end");
    th.addEventListener("click", () => {
      const sortKey = c.sortKey || c.key;
      if (sheetsSortCol === sortKey) sheetsSortAsc = !sheetsSortAsc;
      else { sheetsSortCol = sortKey; sheetsSortAsc = sortKey === "team_displayName" || sortKey === "conference"; }
      saveState();
      renderTeamSheets();
    });
    headerRow.appendChild(th);
  });

  /* ---- build rows ---- */
  const tbody = document.getElementById("sheetsTbody");
  const frags = [];
  rows.forEach((r, i) => {
    const cells = [];
    // # column (NET rank)
    cells.push(`<td style="text-align:center;color:var(--text-dim)">${r.NET ?? "‚Äì"}</td>`);
    // Team
    const teamLink = r.team_abbr
      ? `<a href="team.html?team=${encodeURIComponent(r.team_abbr)}">${r.team_displayName}</a>`
      : r.team_displayName;
    cells.push(`<td class="team-cell" style="text-align:left">${teamLink}</td>`);
    // Conf
    const confLink = r.conference
      ? `<a href="conference.html?conf=${encodeURIComponent(r.conference)}">${r.conference}</a>`
      : "‚Äì";
    cells.push(`<td class="conf-cell" style="text-align:left">${confLink}</td>`);
    // Proj Seed
    cells.push(`<td style="text-align:center">${r.proj_seed ?? "‚Äì"}</td>`);
    // NET (standalone)
    const netBg = sheetsRankHeat(r.NET, maxRanks.NET);
    cells.push(`<td class="heatmap" style="text-align:center;${netBg ? 'background:'+netBg : ''}">${r.NET ?? "‚Äì"}</td>`);
    // Result-Based metrics
    RES_COLS.forEach(c => {
      const v = r[c.key];
      const bg = sheetsRankHeat(v, maxRanks[c.key]);
      const style = bg ? `background:${bg}` : "";
      const cls = `heatmap ${c.sectionStart ? "section-start" : ""} ${c.sectionEnd ? "section-end" : ""}`;
      cells.push(`<td class="${cls}" style="text-align:center;${style}">${v ?? "‚Äì"}</td>`);
    });
    // Res Avg
    const raBg = sheetsRankHeat(r._resAvg, resAvgMax);
    cells.push(`<td class="heatmap section-end" style="text-align:center;font-weight:600;${raBg ? 'background:'+raBg : ''}">${r._resAvg.toFixed(1)}</td>`);
    // Predictive metrics
    PRED_COLS.forEach(c => {
      const v = r[c.key];
      const bg = sheetsRankHeat(v, maxRanks[c.key]);
      const style = bg ? `background:${bg}` : "";
      const cls = `heatmap ${c.sectionStart ? "section-start" : ""} ${c.sectionEnd ? "section-end" : ""}`;
      cells.push(`<td class="${cls}" style="text-align:center;${style}">${v ?? "‚Äì"}</td>`);
    });
    // Pred Avg
    const paBg = sheetsRankHeat(r._predAvg, predAvgMax);
    cells.push(`<td class="heatmap section-end" style="text-align:center;font-weight:600;${paBg ? 'background:'+paBg : ''}">${r._predAvg.toFixed(1)}</td>`);
    frags.push(`<tr>${cells.join("")}</tr>`);
  });
  tbody.innerHTML = frags.join("");
  document.getElementById("sheetsCount").textContent = `${rows.length} teams`;
}

/* ---- bracket grid view ---- */
function renderBracket() {
  const teams = DATA.filter(r => r.bracket === "auto" || r.bracket === "at-large")
    .sort((a, b) => (a.rank_seed || 999) - (b.rank_seed || 999));

  /* Each column defines its header and seed-line groups with explicit sizes.
     Seeds 1-10: 4 teams each, 11: 6, 12: 4, 13-15: 4 each, 16: 6  = 68 */
  const columns = [
    { label: "1 ‚Äì 4 Seeds",   groups: [ {seed:1,n:4},{seed:2,n:4},{seed:3,n:4},{seed:4,n:4} ] },
    { label: "5 ‚Äì 8 Seeds",   groups: [ {seed:5,n:4},{seed:6,n:4},{seed:7,n:4},{seed:8,n:4} ] },
    { label: "9 ‚Äì 12 Seeds",  groups: [ {seed:9,n:4},{seed:10,n:4},{seed:11,n:6},{seed:12,n:4} ] },
    { label: "13 ‚Äì 16 Seeds", groups: [ {seed:13,n:4},{seed:14,n:4},{seed:15,n:4},{seed:16,n:6} ] },
  ];

  /* Identify last 4 at-large teams (lowest SLCT among at-large) */
  const atLargeTeams = teams.filter(t => t.bracket === "at-large")
    .sort((a, b) => (a.slct || 0) - (b.slct || 0));
  const lastFourAbbrs = new Set(atLargeTeams.slice(0, 4).map(t => t.team_abbr));

  function teamRow(t, idx) {
    const rank = idx + 1;
    const bidCls = t.bracket === "auto" ? "auto" : "at-large";
    const bidLabel = t.bracket === "auto" ? "AQ" : "AL";
    const isL4 = lastFourAbbrs.has(t.team_abbr);
    const l4Badge = isL4 ? ' <span class="l4-badge">L4</span>' : '';
    const link = `<a href="team.html?team=${encodeURIComponent(t.team_abbr)}">${t.team_displayName}</a>`;
    return `<div class="bracket-row">
      <span class="bracket-seed">${rank}</span>
      <span class="bracket-team">${link}${l4Badge}</span>
      <span class="bracket-bid ${bidCls}">${bidLabel}</span>
      <span class="bracket-stat">${t.slct?.toFixed(2) ?? "‚Äì"}</span>
      <span class="bracket-stat">${t.seed?.toFixed(2) ?? "‚Äì"}</span>
    </div>`;
  }

  const grid = document.getElementById("bracketGrid");
  let pos = 0;   // running position across all 68 teams
  grid.innerHTML = columns.map(col => {
    const groupsHtml = col.groups.map(g => {
      const block = teams.slice(pos, pos + g.n);
      const rows = block.map((t, j) => teamRow(t, pos + j)).join("");
      pos += g.n;
      return `<div class="seed-group">
        <div class="seed-group-label">${g.seed} seed</div>
        <div class="seed-group-teams">${rows}</div>
      </div>`;
    }).join("");
    return `<div class="bracket-col">
      <div class="bracket-col-header">
        <span>${col.label}</span>
        <span><span>SLCT</span><span>SEED</span></span>
      </div>
      ${groupsHtml}
    </div>`;
  }).join("");

  // ---- bubble: first 4 out & next 4 out ----
  const first4 = DATA.filter(r => r.bracket === "first_four_out")
    .sort((a, b) => (b.slct || 0) - (a.slct || 0));
  const next4 = DATA.filter(r => r.bracket === "next_four_out")
    .sort((a, b) => (b.slct || 0) - (a.slct || 0));

  function bubbleRow(t) {
    const link = `<a href="team.html?team=${encodeURIComponent(t.team_abbr)}">${t.team_displayName}</a>`;
    return `<div class="bracket-row">
      <span class="bracket-team">${link}</span>
      <span class="bracket-stat">${t.slct?.toFixed(2) ?? "‚Äì"}</span>
      <span class="bracket-stat">${t.seed?.toFixed(2) ?? "‚Äì"}</span>
    </div>`;
  }

  document.getElementById("bubbleSection").innerHTML = [
    { teams: first4, label: "First Four Out", cls: "first-out" },
    { teams: next4,  label: "Next Four Out",  cls: "next-out" },
  ].map(b => `<div class="bubble-box">
    <div class="bubble-header ${b.cls}">
      <span>${b.label}</span>
      <span><span>SLCT</span><span>SEED</span></span>
    </div>
    ${b.teams.map(t => bubbleRow(t)).join("")}
  </div>`).join("");
}

/* ---- tab switching ---- */
function switchTab(tab, col, asc) {
  if (activeTab === tab) return;
  gtag('event', 'tab_click', { event_category: 'navigation', event_label: tab, page: 'rankings' });
  activeTab = tab;
  sortCol = col; sortAsc = asc;
  saveState();
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById("tab" + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add("active");

  const tableWrap = document.querySelector(".table-wrap");
  const bracketWrap = document.getElementById("bracketWrap");
  const seedOddsWrap = document.getElementById("seedOddsWrap");
  const compareWrap = document.getElementById("compareWrap");
  const teamSheetsWrap = document.getElementById("teamSheetsWrap");
  const controls = document.querySelector(".controls");
  if (tab === "brack") {
    tableWrap.style.display = "none";
    controls.style.display = "none";
    bracketWrap.style.display = "block";
    seedOddsWrap.style.display = "none";
    compareWrap.style.display = "none";
    teamSheetsWrap.style.display = "none";
    renderBracket();
  } else if (tab === "seedOdds") {
    tableWrap.style.display = "none";
    controls.style.display = "none";
    bracketWrap.style.display = "none";
    seedOddsWrap.style.display = "block";
    compareWrap.style.display = "none";
    teamSheetsWrap.style.display = "none";
    renderSeedOdds();
  } else if (tab === "compare") {
    tableWrap.style.display = "none";
    controls.style.display = "none";
    bracketWrap.style.display = "none";
    seedOddsWrap.style.display = "none";
    compareWrap.style.display = "block";
    teamSheetsWrap.style.display = "none";
    renderCompareTags();
    renderCompareTable();
  } else if (tab === "sheets") {
    tableWrap.style.display = "none";
    controls.style.display = "none";
    bracketWrap.style.display = "none";
    seedOddsWrap.style.display = "none";
    compareWrap.style.display = "none";
    teamSheetsWrap.style.display = "block";
    renderTeamSheets();
  } else {
    tableWrap.style.display = "";
    controls.style.display = "";
    bracketWrap.style.display = "none";
    seedOddsWrap.style.display = "none";
    compareWrap.style.display = "none";
    teamSheetsWrap.style.display = "none";
    document.getElementById("mainTable").classList.toggle("adv-mode", tab === "advOff" || tab === "advDef");
    buildHeader(); render();
  }
}
document.getElementById("tabRank").addEventListener("click", () => switchTab("rank", "net_srs", false));
document.getElementById("tabQuad").addEventListener("click", () => switchTab("quad", "season_wab", false));
document.getElementById("tabAdvOff").addEventListener("click", () => switchTab("advOff", "OffEff_srs", false));
document.getElementById("tabAdvDef").addEventListener("click", () => switchTab("advDef", "DefEff_srs", true));
document.getElementById("tabBrack").addEventListener("click", () => switchTab("brack", "rank_seed", true));
document.getElementById("tabBubble").addEventListener("click", () => switchTab("bubble", "rank_slct", true));
document.getElementById("tabSeedOdds").addEventListener("click", () => switchTab("seedOdds", "make_pct", false));
document.getElementById("tabCompare").addEventListener("click", () => switchTab("compare", null, false));
document.getElementById("tabSheets").addEventListener("click", () => switchTab("sheets", "NET", true));

/* ---- comparison tool ---- */

/* helper: get best N wins or worst N losses for a team, by WAB */
function getTopGames(abbr, type, n = 3) {
  const games = GAMES_DATA[abbr];
  if (!games || games.length === 0) return [];
  if (type === "wins") {
    return games.filter(g => g._won)
      .sort((a, b) => b.wab - a.wab)
      .slice(0, n);
  } else {
    return games.filter(g => !g._won)
      .sort((a, b) => a.wab - b.wab)
      .slice(0, n);
  }
}

/* format a list of games as HTML lines: "#4 ILL (+0.91)" */
function formatGameList(games, type, useNet = false) {
  if (!games || games.length === 0) return `<span class="game-list-none">None</span>`;
  return games.map(g => {
    const rank = useNet ? (NET_RANKS[g.opp_team_abbr] ?? g.opp_seed_rank) : g.opp_seed_rank;
    const name = g.opp_team_abbr || "‚Äì";
    const wab = g.wab >= 0 ? "+" + g.wab.toFixed(2) : g.wab.toFixed(2);
    const cls = type === "wins" ? "net-pos" : "net-neg";
    const loc = g.homeAway === "away" ? "at" : g.homeAway === "home" ? "vs" : "vs (N)";
    return `<div class="game-list-item"><span class="game-list-rank">${loc} #${rank}</span> <a href="team.html?team=${encodeURIComponent(g.opp_team_abbr)}" class="game-list-link">${name}</a> <span class="${cls}">(${wab})</span></div>`;
  }).join("");
}

const COMPARE_COLS = [
  { key: "team_displayName", label: "Team",         align: "left",   link: true },
  { key: "conference",       label: "Conf",         align: "left" },
  { key: "record",           label: "Record",       align: "center" },
  { key: "streak",           label: "Streak",       align: "center", cls: v => v?.[0] === "W" ? "net-pos" : v?.[0] === "L" ? "net-neg" : "" },
  { key: "net_srs",          label: "Total AdjE",   align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", best: "high", sort: "high" },
  { key: "sos",              label: "SOS",           align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", best: "high", sort: "high" },
  { key: "nc_sos",           label: "NC SOS",        align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", best: "high", sort: "high" },
  { key: "season_wab",       label: "WAB",           align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(1), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", best: "high", sort: "high" },
  { key: "q1a_record",       label: "Q1A",           align: "center", quadTip: "q1a", sort: "high", sortKey: "q1a_w" },
  { key: "q1_record",        label: "Q1",            align: "center", quadTip: 1, sort: "high", sortKey: "q1_w" },
  { key: "q2_record",        label: "Q2",            align: "center", quadTip: 2, sort: "high", sortKey: "q2_w" },
  { key: "q12_record",       label: "Q1+Q2",         align: "center", sort: "high", sortKey: "q12_w" },
  { key: "q3_record",        label: "Q3",            align: "center", quadTip: 3, sort: "high", sortKey: "q3_w" },
  { key: "q4_record",        label: "Q4",            align: "center", quadTip: 4, sort: "high", sortKey: "q4_w" },
  { key: "slct",             label: "SLCT",           align: "center", fmt: v => v?.toFixed(2), best: "high", sort: "high" },
  { key: "seed",             label: "SEED",           align: "center", fmt: v => v?.toFixed(2), best: "high", sort: "high" },
  { key: "_best3wins",       label: "Best 3 Wins",    align: "left",  custom: true },
  { key: "_worst3losses",    label: "Worst 3 Losses", align: "left",  custom: true },
];

const COMPARE_SHEETS_COLS = [
  { key: "team_displayName", label: "Team",         align: "left",   link: true },
  { key: "conference",       label: "Conf",         align: "left" },
  { key: "net_srs",          label: "AIB AdjE",     align: "center", fmt: v => (v >= 0 ? "+" : "") + v?.toFixed(2), cls: v => v > 0 ? "net-pos" : v < 0 ? "net-neg" : "", best: "high", sort: "high" },
  /* NET section */
  { key: "_NET",             label: "NET",           align: "center", sheet: true, best: "low", sectionStart: true, sort: "low" },
  { key: "_SOS",             label: "SOS",           align: "center", sheet: true, best: "low", sort: "low" },
  { key: "_NC_SOS",          label: "NC SOS",        align: "center", sheet: true, best: "low", sectionEnd: true, sort: "low" },
  /* Resume ranks */
  { key: "_KPI",             label: "KPI",           align: "center", sheet: true, best: "low", sectionStart: true, sort: "low" },
  { key: "_SOR",             label: "SOR",           align: "center", sheet: true, best: "low", sort: "low" },
  { key: "_WAB",             label: "WAB",           align: "center", sheet: true, best: "low", sort: "low" },
  { key: "_resAvg",          label: "Res Avg",       align: "center", sheet: true, best: "low", sectionEnd: true, sort: "low",
    fmt: v => v != null ? v.toFixed(1) : "‚Äì" },
  /* Predictive ranks */
  { key: "_BPI",             label: "BPI",           align: "center", sheet: true, best: "low", sectionStart: true, sort: "low" },
  { key: "_POM",             label: "KP",            align: "center", sheet: true, best: "low", sort: "low" },
  { key: "_TRK",             label: "TRK",           align: "center", sheet: true, best: "low", sort: "low" },
  { key: "_predAvg",         label: "Pred Avg",      align: "center", sheet: true, best: "low", sectionEnd: true, sort: "low",
    fmt: v => v != null ? v.toFixed(1) : "‚Äì" },
  /* Quadrant records */
  { key: "q1a_record",       label: "Q1A",           align: "center", quadTip: "q1a", sort: "high", sortKey: "q1a_w" },
  { key: "q1_record",        label: "Q1",            align: "center", quadTip: 1, sort: "high", sortKey: "q1_w" },
  { key: "q2_record",        label: "Q2",            align: "center", quadTip: 2, sort: "high", sortKey: "q2_w" },
  { key: "q12_record",       label: "Q1+Q2",         align: "center", sort: "high", sortKey: "q12_w" },
  { key: "q3_record",        label: "Q3",            align: "center", quadTip: 3, sort: "high", sortKey: "q3_w" },
  { key: "q4_record",        label: "Q4",            align: "center", quadTip: 4, sort: "high", sortKey: "q4_w" },
  /* Best/worst games */
  { key: "_best3wins",       label: "Best 3 Wins",    align: "left",  custom: true },
  { key: "_worst3losses",    label: "Worst 3 Losses", align: "left",  custom: true },
];

let compareTeams = [];  // array of team_abbr strings
let compareShowSheets = false;  // toggle for teamsheet ranks view
let compareShowHAN = false;     // toggle for H/A/N quad breakdown
let compareSortCol = null;   // key of column currently sorted by
let compareSortAsc = true;   // true = ascending (low to high)

function renderCompareTags() {
  const tagsEl = document.getElementById("compareTags");
  if (compareTeams.length === 0) {
    tagsEl.innerHTML = "";
    return;
  }
  const lookup = {};
  DATA.forEach(t => { lookup[t.team_abbr] = t; });
  let html = compareTeams.map(abbr => {
    const t = lookup[abbr];
    const name = t ? t.team_displayName : abbr;
    return `<span class="compare-tag">${name}<span class="remove-tag" data-abbr="${abbr}">&times;</span></span>`;
  }).join("");
  html += `<button class="compare-clear" id="compareClearAll">Clear all</button>`;
  tagsEl.innerHTML = html;

  tagsEl.querySelectorAll(".remove-tag").forEach(btn => {
    btn.addEventListener("click", () => {
      compareTeams = compareTeams.filter(a => a !== btn.dataset.abbr);
      renderCompareTags();
      renderCompareTable();
    });
  });
  document.getElementById("compareClearAll").addEventListener("click", () => {
    compareTeams = [];
    renderCompareTags();
    renderCompareTable();
  });
}

function renderCompareTable() {
  const emptyEl = document.getElementById("compareEmpty");
  const tableEl = document.getElementById("compareTable");

  if (compareTeams.length === 0) {
    emptyEl.style.display = "";
    tableEl.style.display = "none";
    return;
  }
  emptyEl.style.display = "none";
  tableEl.style.display = "";

  const COLS = compareShowSheets ? COMPARE_SHEETS_COLS : COMPARE_COLS;

  const lookup = {};
  DATA.forEach(t => { lookup[t.team_abbr] = t; });

  /* merge teamsheet data onto team objects */
  const sheetsLookup = {};
  SHEETS_DATA.forEach(s => { sheetsLookup[s.team_abbr] = s; });
  const nSheets = SHEETS_DATA.length || 1;

  const teams = compareTeams.map(a => {
    const orig = lookup[a];
    if (!orig) return null;
    const t = { ...orig };  /* shallow clone ‚Äî don't mutate original DATA */
    /* attach sheet ranks if in sheets mode */
    const s = sheetsLookup[a];
    if (s) {
      t._NET = s.NET; t._KPI = s.KPI; t._SOR = s.SOR; t._WAB = s.WAB;
      t._BPI = s.BPI; t._POM = s.POM; t._TRK = s.TRK;
      t._SOS = s.SOS; t._NC_SOS = s.NC_SOS;
      const resKeys = ["KPI","SOR","WAB"];
      t._resAvg = resKeys.reduce((sum, k) => sum + (s[k] || 0), 0) / resKeys.length;
      const predKeys = ["BPI","POM","TRK"];
      t._predAvg = predKeys.reduce((sum, k) => sum + (s[k] || 0), 0) / predKeys.length;
    } else {
      t._NET = null; t._KPI = null; t._SOR = null; t._WAB = null;
      t._BPI = null; t._POM = null; t._TRK = null;
      t._SOS = null; t._NC_SOS = null;
      t._resAvg = null; t._predAvg = null;
    }
    /* when showing teamsheet view, recompute quad records using official NET rankings */
    if (compareShowSheets) {
      const games = GAMES_DATA[a] || [];
      const qw = {1:0,2:0,3:0,4:0}, ql = {1:0,2:0,3:0,4:0};
      let q1aw = 0, q1al = 0;
      /* H/A/N per-location tracking */
      const hanW = {}, hanL = {};
      for (const q of [1,2,3,4]) { for (const loc of ["home","away","neutral"]) { hanW[q+"_"+loc]=0; hanL[q+"_"+loc]=0; } }
      const q1aHan = {home_w:0,home_l:0,away_w:0,away_l:0,neutral_w:0,neutral_l:0};
      games.forEach(g => {
        const netRank = NET_RANKS[g.opp_team_abbr];
        const q = getOfficialQuad(g.homeAway, netRank);
        if (q == null) return;
        const loc = g.homeAway || "neutral";
        if (g._won) { qw[q]++; hanW[q+"_"+loc]++; } else { ql[q]++; hanL[q+"_"+loc]++; }
        if (isQ1A(g.homeAway, netRank)) {
          if (g._won) { q1aw++; q1aHan[loc+"_w"]++; } else { q1al++; q1aHan[loc+"_l"]++; }
        }
      });
      for (const q of [1,2,3,4]) {
        t["q" + q + "_w"] = qw[q];
        t["q" + q + "_l"] = ql[q];
        t["q" + q + "_record"] = qw[q] + "-" + ql[q];
      }
      t.q12_w = qw[1] + qw[2]; t.q12_l = ql[1] + ql[2];
      t.q12_record = t.q12_w + "-" + t.q12_l;
      t.q1a_w = q1aw; t.q1a_l = q1al;
      t.q1a_record = q1aw + "-" + q1al;
      /* store H/A/N breakdowns */
      for (const q of [1,2,3,4]) {
        for (const loc of ["home","away","neutral"]) {
          t["_han_q"+q+"_"+loc] = hanW[q+"_"+loc] + "-" + hanL[q+"_"+loc];
        }
      }
      for (const loc of ["home","away","neutral"]) {
        t["_han_q12_"+loc] = (hanW["1_"+loc]+hanW["2_"+loc]) + "-" + (hanL["1_"+loc]+hanL["2_"+loc]);
        t["_han_q1a_"+loc] = q1aHan[loc+"_w"] + "-" + q1aHan[loc+"_l"];
      }
    }
    /* H/A/N for non-sheet mode: use original quad assignments */
    if (!compareShowSheets && compareShowHAN) {
      const games = GAMES_DATA[a] || [];
      const hanW = {}, hanL = {};
      for (const q of [1,2,3,4]) { for (const loc of ["home","away","neutral"]) { hanW[q+"_"+loc]=0; hanL[q+"_"+loc]=0; } }
      const q1aHan = {home_w:0,home_l:0,away_w:0,away_l:0,neutral_w:0,neutral_l:0};
      games.forEach(g => {
        const q = g.quad;
        if (q == null) return;
        const loc = g.homeAway || "neutral";
        if (g._won) hanW[q+"_"+loc]++; else hanL[q+"_"+loc]++;
        if (isQ1A(g.homeAway, g.opp_seed_rank)) {
          if (g._won) q1aHan[loc+"_w"]++; else q1aHan[loc+"_l"]++;
        }
      });
      for (const q of [1,2,3,4]) {
        for (const loc of ["home","away","neutral"]) {
          t["_han_q"+q+"_"+loc] = hanW[q+"_"+loc] + "-" + hanL[q+"_"+loc];
        }
      }
      for (const loc of ["home","away","neutral"]) {
        t["_han_q12_"+loc] = (hanW["1_"+loc]+hanW["2_"+loc]) + "-" + (hanL["1_"+loc]+hanL["2_"+loc]);
        t["_han_q1a_"+loc] = q1aHan[loc+"_w"] + "-" + q1aHan[loc+"_l"];
      }
    }
    /* compute win% for each quadrant (for best-value comparison) */
    for (const q of ["q1a","q1","q2","q3","q4","q12"]) {
      const w = t[q + "_w"] ?? 0, l = t[q + "_l"] ?? 0;
      t["_" + q + "_wpct"] = (w + l) > 0 ? w / (w + l) : null;
    }
    return t;
  }).filter(Boolean);

  /* find best value for each column (for highlighting) */
  const bestVals = {};
  COLS.forEach(c => {
    if (!c.best) return;
    const sk = c.sortKey || c.key;
    const vals = teams.map(t => t[sk]).filter(v => v != null);
    if (vals.length === 0) return;
    if (c.best === "high" || c.best === "high_w") bestVals[c.key] = Math.max(...vals);
    else bestVals[c.key] = Math.min(...vals);
  });

  /* header */
  const thead = document.getElementById("compareHeader");
  thead.innerHTML = COLS.map(c => {
    let cls = "";
    if (c.sectionStart) cls += " section-start";
    if (c.sectionEnd) cls += " section-end";
    const sk = c.sortKey || c.key;
    const isSorted = compareSortCol === sk;
    const arrow = isSorted ? (compareSortAsc ? " ‚ñ≤" : " ‚ñº") : "";
    const sortCls = c.sort ? " compare-sortable" : "";
    const sortAttr = c.sort ? ` data-sort-key="${sk}" data-sort-dir="${c.sort}"` : "";
    return `<th class="${cls}${sortCls}${isSorted ? ' compare-sorted' : ''}" style="text-align:${c.align || 'center'}"${sortAttr}>${c.label}${arrow}</th>`;
  }).join("");

  /* attach sort click handlers */
  thead.querySelectorAll(".compare-sortable").forEach(th => {
    th.addEventListener("click", () => {
      const sk = th.dataset.sortKey;
      const defaultDir = th.dataset.sortDir;  /* "high" or "low" */
      if (compareSortCol === sk) {
        compareSortAsc = !compareSortAsc;  /* toggle direction */
      } else {
        compareSortCol = sk;
        compareSortAsc = defaultDir === "low";  /* low = asc first, high = desc first */
      }
      renderCompareTable();
    });
  });

  /* sort teams if a sort column is active */
  if (compareSortCol) {
    teams.sort((a, b) => {
      const va = a[compareSortCol] ?? (compareSortAsc ? Infinity : -Infinity);
      const vb = b[compareSortCol] ?? (compareSortAsc ? Infinity : -Infinity);
      return compareSortAsc ? va - vb : vb - va;
    });
  }

  /* rows */
  const tbody = document.getElementById("compareTbody");
  const frags = [];
  teams.forEach(t => {
    const cells = COLS.map(c => {
      let display, cls = "", tdCls = "";
      let style = `text-align:${c.align || 'center'}`;
      let extraCls = "";
      if (c.sectionStart) extraCls += " section-start";
      if (c.sectionEnd) extraCls += " section-end";

      /* custom columns: best wins / worst losses */
      if (c.custom) {
        if (c.key === "_best3wins") {
          display = formatGameList(getTopGames(t.team_abbr, "wins", 3), "wins", compareShowSheets);
        } else if (c.key === "_worst3losses") {
          display = formatGameList(getTopGames(t.team_abbr, "losses", 3), "losses", compareShowSheets);
        } else {
          display = "‚Äì";
        }
        tdCls = "game-list-cell";
        return `<td class="${tdCls}${extraCls}" style="${style}">${display}</td>`;
      }

      const v = t[c.key];
      display = c.fmt ? c.fmt(v) : (v ?? "‚Äì");
      cls = c.cls ? c.cls(v) : "";

      /* H/A/N breakdown for quad record cells */
      if (compareShowHAN && c.key.endsWith("_record")) {
        const qTag = c.key.replace("_record", "");          // "q1", "q1a", "q12", etc.
        const hRec = t["_han_" + qTag + "_home"]    || "0-0";
        const aRec = t["_han_" + qTag + "_away"]    || "0-0";
        const nRec = t["_han_" + qTag + "_neutral"] || "0-0";
        display = `<div class="han-stack">`
          + `<div class="han-line"><span class="han-label">H:</span>${hRec}</div>`
          + `<div class="han-line"><span class="han-label">A:</span>${aRec}</div>`
          + `<div class="han-line"><span class="han-label">N:</span>${nRec}</div>`
          + `</div>`;
      }

      if (c.link && t.team_abbr) {
        display = `<a href="team.html?team=${encodeURIComponent(t.team_abbr)}">${display}</a>`;
        tdCls = "team-cell";
      }

      /* heatmap for sheet rank columns */
      if (c.sheet && v != null) {
        const bg = sheetsRankHeat(v, nSheets);
        if (bg) style += `;background:${bg}`;
      }

      /* highlight best value */
      if (c.best && bestVals[c.key] != null && teams.length > 1) {
        const sk = c.sortKey || c.key;
        if (t[sk] != null && t[sk] === bestVals[c.key]) {
          cls += " best-val";
        }
      }

      /* quadrant tooltip ‚Äî always show below in comparison table */
      if (c.quadTip != null && t.team_abbr) {
        const tip = buildQuadTip(t.team_abbr, c.quadTip, compareShowSheets);
        if (tip) {
          return `<td class="quad-tip-cell quad-tip-below ${tdCls} ${cls}${extraCls}" style="${style}">${display}${tip}</td>`;
        }
      }

      return `<td class="${tdCls} ${cls}${extraCls}" style="${style}">${display}</td>`;
    }).join("");
    frags.push(`<tr>${cells}</tr>`);
  });
  tbody.innerHTML = frags.join("");
}

/* autocomplete */
const compareInput = document.getElementById("compareSearch");
const compareAC = document.getElementById("compareAutocomplete");

compareInput.addEventListener("input", () => {
  const q = compareInput.value.toLowerCase().trim();
  if (!q) { compareAC.style.display = "none"; return; }

  const matches = DATA.filter(t =>
    !compareTeams.includes(t.team_abbr) &&
    (t.team_displayName?.toLowerCase().includes(q) || t.team_abbr?.toLowerCase().includes(q))
  ).slice(0, 10);

  if (matches.length === 0) { compareAC.style.display = "none"; return; }
  compareAC.style.display = "block";
  compareAC.innerHTML = matches.map(t =>
    `<div data-abbr="${t.team_abbr}">
      <span>${t.team_displayName}</span>
      <span class="ac-conf">${t.conference || ""}</span>
    </div>`
  ).join("");

  compareAC.querySelectorAll("div").forEach(el => {
    el.addEventListener("click", () => {
      compareTeams.push(el.dataset.abbr);
      compareInput.value = "";
      compareAC.style.display = "none";
      renderCompareTags();
      renderCompareTable();
    });
  });
});

compareInput.addEventListener("keydown", (e) => {
  if (e.key === "Escape") { compareAC.style.display = "none"; }
});

document.addEventListener("click", (e) => {
  if (!e.target.closest(".compare-controls")) {
    compareAC.style.display = "none";
  }
});

/* teamsheet ranks toggle */
document.getElementById("compareSheetToggle").addEventListener("click", () => {
  compareShowSheets = !compareShowSheets;
  document.getElementById("compareSheetToggle").classList.toggle("active", compareShowSheets);
  renderCompareTable();
});

/* H/A/N breakdown toggle */
document.getElementById("compareHANToggle").addEventListener("click", () => {
  compareShowHAN = !compareShowHAN;
  document.getElementById("compareHANToggle").classList.toggle("active", compareShowHAN);
  if (typeof gtag === "function") gtag("event", "tab_click", { event_label: "compare_han_toggle", page: "index" });
  renderCompareTable();
});

/* ---- search listeners ---- */
document.getElementById("search").addEventListener("input", render);
document.getElementById("seedOddsSearch").addEventListener("input", renderSeedOdds);
document.getElementById("sheetsSearch").addEventListener("input", renderTeamSheets);
</script>
</body>
</html>
